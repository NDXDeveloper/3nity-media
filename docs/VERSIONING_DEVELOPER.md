# Versioning Developer Documentation

This document describes the versioning system for 3nity Media, including how versions are generated, injected into the application, and used throughout the codebase.

## Overview

3nity Media uses a **git-based versioning system** that automatically extracts version information from git tags and commits, then injects this information into the Pascal source code at build time.

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Git Tags      │────▶│    Makefile     │────▶│  uVersion.inc   │
│   Git Commits   │     │                 │     │  (constants)    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                                        │
                                                        ▼
                              ┌─────────────────────────────────────┐
                              │          uAppVersion.pas            │
                              │   (wrapper functions for access)    │
                              └─────────────────────────────────────┘
                                                        │
                                                        ▼
                              ┌─────────────────────────────────────┐
                              │        Application (UI, etc.)       │
                              │    About dialog, Window title...    │
                              └─────────────────────────────────────┘
```

## Version Components

| Component | Source | Example |
|-----------|--------|---------|
| `APP_VERSION` | `git describe --tags` | `v0.1.0` or `v0.1.0-5-g1a2b3c4` |
| `APP_BUILD_DATE` | `date -u +%Y-%m-%d` | `2025-12-31` |
| `APP_BUILD_TIME` | `date -u +%H:%M:%S` | `16:47:48` |
| `APP_GIT_COMMIT` | `git rev-parse --short HEAD` | `1a2b3c4` |
| `APP_GIT_BRANCH` | `git rev-parse --abbrev-ref HEAD` | `main` |

### Version String Format

The `APP_VERSION` is derived from git in several formats:

| Scenario | Command Output | Example |
|----------|----------------|---------|
| Exactly on a tag | `v0.1.0` | Release version |
| N commits after tag | `v0.1.0-5-g1a2b3c4` | Development version |
| No tags exist | `1a2b3c4` | Commit hash only |
| Uncommitted changes | `v0.1.0-dirty` | Modified working tree |
| Not a git repo | `dev` | Fallback value |

## File Structure

### Source Files

| File | Purpose |
|------|---------|
| `src/Core/uVersion.inc` | Auto-generated constants (DO NOT EDIT) |
| `src/Core/uAppVersion.pas` | Wrapper unit with helper functions |

### Build Files

| File | Purpose |
|------|---------|
| `Makefile` | Generates `uVersion.inc` and builds the application |

## Makefile Targets

### Version Commands

```bash
# Display current version information
make version

# Generate/update uVersion.inc without building
make version-file

# Build with automatic version injection (recommended)
make build-app      # Debug mode
make build-release  # Release mode (optimized)

# Build with specific version
make release V=0.1.0
```

### Example Output

```bash
$ make version
3nity Media - Informations de version
  Version:    v0.1.0
  Date:       2025-12-31
  Heure:      16:47:48
  Commit:     1a2b3c4
  Branche:    main
```

## Generated File: uVersion.inc

The Makefile generates `src/Core/uVersion.inc`:

```pascal
{ Auto-generated by Makefile - DO NOT EDIT }
{ Generated: 2025-12-31 16:47:48 }

const
  APP_VERSION = 'v0.1.0';
  APP_BUILD_DATE = '2025-12-31';
  APP_BUILD_TIME = '16:47:48';
  APP_GIT_COMMIT = '1a2b3c4';
  APP_GIT_BRANCH = 'main';
```

**Important:** This file is auto-generated. Never edit it manually.

## Wrapper Unit: uAppVersion.pas

The `uAppVersion` unit provides convenient functions to access version information:

### Available Functions

| Function | Returns | Example Output |
|----------|---------|----------------|
| `GetAppName` | Application name | `3nity Media` |
| `GetAppVersion` | Version with 'v' prefix | `v0.1.0` |
| `GetAppVersionShort` | Version without 'v' | `0.1.0` |
| `GetAppFullVersion` | Name + version | `3nity Media v0.1.0` |
| `GetBuildDate` | Build date | `2025-12-31` |
| `GetBuildTime` | Build time | `16:47:48` |
| `GetBuildDateTime` | Date + time | `2025-12-31 16:47:48` |
| `GetGitCommit` | Short commit hash | `1a2b3c4` |
| `GetGitBranch` | Branch name | `main` |
| `GetBuildInfo` | Full build details | `Built: 2025-12-31 16:47:48 \| Commit: 1a2b3c4 (main)` |
| `GetFullVersionInfo` | Version + commit | `v0.1.0 (1a2b3c4)` |
| `GetVersionForTitle` | Window title format | `3nity Media v0.1.0` |
| `GetVersionForAbout` | Multi-line for dialogs | Full version info block |

### Usage Example

```pascal
uses
  uAppVersion;

procedure TfrmMain.FormCreate(Sender: TObject);
begin
  Caption := GetVersionForTitle;  // "3nity Media v0.1.0"
end;

procedure TfrmAbout.ShowInfo;
begin
  lblVersion.Caption := 'Version ' + GetFullVersionInfo;  // "Version v0.1.0 (1a2b3c4)"
  lblBuild.Caption := GetBuildInfo;  // "Built: 2025-12-31 16:47:48 | Commit: 1a2b3c4 (main)"
end;
```

## CI/CD Version Handling

In GitHub Actions (`build.yml`), version is extracted differently:

### For Tagged Releases

```yaml
# Extract version from tag (e.g., v0.1.0 → 0.1.0)
VERSION=${GITHUB_REF#refs/tags/}
VERSION=${VERSION#v}
```

### For Development Builds

```yaml
# Generate dev version: 0.0.0-dev.YYYYMMDD.COMMIT
VERSION="0.0.0-dev.$(date +%Y%m%d).${GITHUB_SHA::7}"
```

### Package Naming

All packages include the version in their filename:

| Platform | Package Pattern |
|----------|-----------------|
| Linux DEB | `3nity-media_VERSION_amd64.deb` |
| AppImage | `3nity-Media-VERSION-x86_64.AppImage` |
| Snap | `3nity-media_VERSION_amd64.snap` |
| Flatpak | `3nity-media-VERSION.flatpak` |
| Windows Installer | `3nity-Media-Setup-VERSION.exe` |
| Windows Portable | `3nity-media-windows-portable-VERSION.zip` |

## Creating a New Release

### Step 1: Tag the Release

```bash
# Create annotated tag
git tag -a v0.2.0 -m "Release 0.2.0: New features..."

# Push tag to trigger CI/CD
git push origin v0.2.0
```

### Step 2: Local Build (Optional)

```bash
# Build release locally
make release V=0.2.0

# Output: releases/3nity-0.2.0-linux-x64
```

### Step 3: CI/CD Automatic Build

When a tag is pushed:
1. CI/CD extracts version from tag
2. Builds for Linux and Windows
3. Creates GitHub Release with all packages

## Version Display in Application

### Window Title
Uses `GetVersionForTitle`:
```
3nity Media v0.1.0
```

### About Dialog
Uses multiple functions:
- Version line: `GetFullVersionInfo` → `v0.1.0 (1a2b3c4)`
- Build info: `GetBuildDateTime` → `2025-12-31 16:47:48`
- Compiler info: `GetGitCommit` → `1a2b3c4`

## Troubleshooting

### "unknown" Values in Version

If `APP_GIT_COMMIT` or `APP_GIT_BRANCH` shows "unknown":
- The build was done outside a git repository
- Git is not installed on the build system
- The `.git` directory is missing

### Version Not Updating

1. Ensure you run `make build-app` (not direct `lazbuild`)
2. Check that `uVersion.inc` was regenerated
3. Force regeneration: `make version-file`

### CI/CD Version Issues

- Ensure tags follow the `vX.Y.Z` format
- Check that the tag is pushed: `git push origin --tags`
- Verify the workflow trigger in `build.yml`

## Best Practices

1. **Always use Makefile** for builds to ensure version injection
2. **Use semantic versioning** (vMAJOR.MINOR.PATCH)
3. **Create annotated tags** with `-a` flag for releases
4. **Never edit uVersion.inc manually** - it will be overwritten
5. **Use uAppVersion functions** instead of accessing constants directly

## Version Information

- **Last updated:** 2026-01-01
- **Applies to:** 3nity Media v0.x and later
