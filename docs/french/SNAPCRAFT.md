# Procédure de publication sur le Snap Store

Ce guide détaille les étapes pour publier 3nity Media sur le Snap Store (Snapcraft).

---

## Prérequis

### Installation de Snapcraft

```bash
sudo snap install snapcraft --classic
```

### Compte Snapcraft

1. Créer un compte sur https://snapcraft.io/account
2. Se connecter localement:
```bash
snapcraft login
```

---

## Phase 1: Préparation du projet

### 1. Structure des fichiers Snap

```
snap/
├── snapcraft.yaml              # Manifest principal
└── gui/
    ├── 3nity-media.desktop     # Fichier desktop
    ├── 3nity-media.png         # Icône principale (256x256)
    ├── 3nity-media-16.png      # Icône 16x16
    ├── 3nity-media-24.png      # Icône 24x24
    ├── 3nity-media-32.png      # Icône 32x32
    ├── 3nity-media-48.png      # Icône 48x48
    ├── 3nity-media-64.png      # Icône 64x64
    ├── 3nity-media-128.png     # Icône 128x128
    └── 3nity-media-256.png     # Icône 256x256
```

### 2. Fichier snapcraft.yaml

```yaml
name: 3nity-media
base: core22
version: '0.1.0'
summary: Modern multimedia player based on libmpv
description: |
  3nity Media is a powerful and elegant multimedia player for Linux,
  built with Lazarus/Free Pascal and powered by libmpv.

  Features:
  - Video playback with hardware acceleration (VA-API, VDPAU)
  - Audio playback with 10-band equalizer
  - DVD and Blu-ray navigation support
  - Internet radio with Icecast directory
  - Playlist management (M3U, M3U8, PLS)
  - Customizable keyboard shortcuts
  - Multi-language interface (100+ languages)
  - Stream recording
  - Audio visualizations
  - Bookmarks and favorites
  - Session restore

  Supported formats: AVI, MKV, MP4, MOV, WMV, FLV, WebM, MP3, FLAC,
  OGG, Opus, AAC, WAV, and many more via libmpv/ffmpeg.

grade: stable
confinement: strict

icon: snap/gui/3nity-media.png

architectures:
  - build-on: amd64

apps:
  3nity-media:
    command: bin/3nity-media
    desktop: share/applications/3nity-media.desktop
    extensions:
      - kde-neon
    plugs:
      - home
      - audio-playback
      - audio-record
      - pulseaudio
      - network
      - network-bind
      - removable-media
      - optical-drive
      - screen-inhibit-control
      - unity7
      - x11
      - wayland
      - opengl
      - desktop
      - desktop-legacy
      - gsettings
      - mount-observe
    environment:
      LD_LIBRARY_PATH: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/pulseaudio:$LD_LIBRARY_PATH
      LIBVA_DRIVER_NAME: ""
      __EGL_VENDOR_LIBRARY_DIRS: $SNAP/usr/share/glvnd/egl_vendor.d

layout:
  /usr/share/libdrm:
    bind: $SNAP/usr/share/libdrm
  /usr/lib/$SNAPCRAFT_ARCH_TRIPLET/dri:
    bind: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/dri

parts:
  # Dépendances de build - IDE Lazarus
  lazarus:
    plugin: nil
    build-packages:
      - lazarus-ide-qt5
      - lazarus-src
      - lcl-qt5
      - lcl-utils
      - fpc
      - fpc-source
    stage-packages:
      - libqt5pas1
    prime:
      - usr/lib/*/libQt5Pas*

  # Application principale
  3nity-media:
    after: [lazarus]
    plugin: nil
    source: .
    build-packages:
      - lazarus-ide-qt5
      - lcl-qt5
      - fpc
      - libmpv-dev
      - libqt5pas-dev
    stage-packages:
      - libmpv2
      - libqt5pas1
      - ffmpeg
      - libva2
      - libva-drm2
      - libva-x11-2
      - libvdpau1
      - mesa-va-drivers
      - mesa-vdpau-drivers
      - libdrm2
      - libdrm-common
      - libegl1
      - libgl1
      - libglx0
      - libglvnd0
      - libpulse0
      - libasound2
      - liblua5.1-0
      - libass9
      - libbluray2
      - libcdio-paranoia2
      - libdvdnav4
      - libdvdread8
      - libjpeg8
      - libplacebo192
      - librubberband2
      - libsdl2-2.0-0
      - libsixel1
      - libsmbclient
      - libuchardet0
      - libxkbcommon0
      - libxss1
      - libzimg2
      - yt-dlp
    override-build: |
      # Générer le fichier de version
      VERSION="${SNAPCRAFT_PROJECT_VERSION}"
      BUILD_DATE=$(date -u +%Y-%m-%d)
      BUILD_TIME=$(date -u +%H:%M:%S)
      GIT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "snap")
      GIT_BRANCH="snap"

      mkdir -p src/Core
      cat > src/Core/uVersion.inc << EOF
      { Auto-generated by snapcraft - DO NOT EDIT }
      { Generated: ${BUILD_DATE} ${BUILD_TIME} }

      const
        APP_VERSION = '${VERSION}';
        APP_BUILD_DATE = '${BUILD_DATE}';
        APP_BUILD_TIME = '${BUILD_TIME}';
        APP_GIT_COMMIT = '${GIT_COMMIT}';
        APP_GIT_BRANCH = '${GIT_BRANCH}';
      EOF

      # Compiler l'application en mode Release
      cd src
      lazbuild --build-mode=Release TrinityMedia.lpi

      # Installer le binaire
      mkdir -p $SNAPCRAFT_PART_INSTALL/bin
      cp ../bin/x86_64-linux/3nity-media $SNAPCRAFT_PART_INSTALL/bin/

      # Installer les fichiers de locale depuis resources/locale/
      mkdir -p $SNAPCRAFT_PART_INSTALL/share/3nity-media/locale
      if [ -d "../resources/locale" ]; then
        cp ../resources/locale/*.lang $SNAPCRAFT_PART_INSTALL/share/3nity-media/locale/
      fi

      # Installer LICENSE et documentation
      mkdir -p $SNAPCRAFT_PART_INSTALL/share/doc/3nity-media
      cp ../LICENSE $SNAPCRAFT_PART_INSTALL/share/doc/3nity-media/ || true
      cp ../README.md $SNAPCRAFT_PART_INSTALL/share/doc/3nity-media/ || true
    prime:
      - bin/3nity-media
      - share/3nity-media/
      - share/doc/3nity-media/
      - usr/lib/*/libmpv*
      - usr/lib/*/libQt5Pas*
      - usr/lib/*/libass*
      - usr/lib/*/libbluray*
      - usr/lib/*/libdvd*
      - usr/lib/*/libva*
      - usr/lib/*/libvdpau*
      - usr/lib/*/libplacebo*
      - usr/lib/*/librubberband*
      - usr/lib/*/libpulse*
      - usr/lib/*/libasound*
      - usr/lib/*/dri/
      - usr/bin/ffprobe
      - usr/bin/yt-dlp
      - usr/share/libdrm/

  # Fichiers d'intégration desktop
  desktop-files:
    plugin: dump
    source: snap/gui
    organize:
      3nity-media.desktop: share/applications/3nity-media.desktop
      3nity-media-16.png: share/icons/hicolor/16x16/apps/3nity-media.png
      3nity-media-24.png: share/icons/hicolor/24x24/apps/3nity-media.png
      3nity-media-32.png: share/icons/hicolor/32x32/apps/3nity-media.png
      3nity-media-48.png: share/icons/hicolor/48x48/apps/3nity-media.png
      3nity-media-64.png: share/icons/hicolor/64x64/apps/3nity-media.png
      3nity-media-128.png: share/icons/hicolor/128x128/apps/3nity-media.png
      3nity-media-256.png: share/icons/hicolor/256x256/apps/3nity-media.png

  # Nettoyage
  cleanup:
    after: [3nity-media, desktop-files]
    plugin: nil
    override-prime: |
      set -eux
      # Supprimer les fichiers inutiles pour réduire la taille du snap
      rm -rf usr/share/doc
      rm -rf usr/share/man
      rm -rf usr/share/lintian
      rm -rf usr/share/bug
      rm -rf usr/lib/*/cmake
      rm -rf usr/lib/*/pkgconfig
      find . -name "*.a" -delete
      find . -name "*.la" -delete
```

### 3. Fichier desktop (snap/gui/3nity-media.desktop)

```ini
[Desktop Entry]
Version=1.0
Type=Application
Name=3nity Media
GenericName=Media Player
Comment=Modern multimedia player powered by libmpv
Exec=3nity-media %F
Icon=${SNAP}/meta/gui/3nity-media.png
Terminal=false
Categories=AudioVideo;Audio;Video;Player;
MimeType=audio/*;video/*;
Keywords=media;player;audio;video;music;movie;stream;radio;
```

---

## Phase 2: Build local

### 4. Compiler l'application

```bash
# S'assurer que le binaire est compilé
make build-release
```

### 5. Préparer les icônes

```bash
mkdir -p snap/gui

# Copier les icônes
for size in 16 24 32 48 64 128 256; do
  cp resources/icons/${size}x${size}.png snap/gui/3nity-media-${size}.png
done
cp resources/icons/256x256.png snap/gui/3nity-media.png
```

### 6. Construire le snap localement

```bash
# Build avec LXD (recommandé)
snapcraft

# Ou build destructif (modifie le système hôte)
snapcraft --destructive-mode
```

### 7. Tester le snap localement

```bash
# Installer le snap local
sudo snap install --dangerous 3nity-media_0.1.0_amd64.snap

# Lancer l'application
snap run 3nity-media

# Vérifier les connexions (permissions)
snap connections 3nity-media

# Désinstaller
sudo snap remove 3nity-media
```

---

## Phase 3: Enregistrement du nom

### 8. Réserver le nom sur le Snap Store

```bash
snapcraft register 3nity-media
```

> **Note:** Le nom doit être unique sur le Snap Store. Si déjà pris, choisir une variante.

### 9. Vérifier l'enregistrement

```bash
snapcraft list-registered
```

---

## Phase 4: Publication

### 10. Pousser le snap vers le Store

```bash
# Upload vers le canal edge (test)
snapcraft upload --release=edge 3nity-media_0.1.0_amd64.snap

# Ou upload sans release immédiat
snapcraft upload 3nity-media_0.1.0_amd64.snap
```

### 11. Canaux de distribution

| Canal | Usage |
|-------|-------|
| `edge` | Builds automatiques, très instable |
| `beta` | Tests publics, peut avoir des bugs |
| `candidate` | Release candidate, tests finaux |
| `stable` | Production, version stable |

### 12. Promouvoir vers stable

```bash
# Via ligne de commande
snapcraft release 3nity-media 1 stable

# Où "1" est le numéro de révision (affiché après upload)
```

---

## Phase 5: Configuration du Store

### 13. Configurer la page du Store

Aller sur https://snapcraft.io/3nity-media/listing et configurer:

| Élément | Description |
|---------|-------------|
| **Icon** | Logo 256x256 PNG ou SVG |
| **Banner** | Image 1920x480 pour la bannière |
| **Screenshots** | Captures d'écran (1280x720 recommandé) |
| **Description** | Description détaillée en Markdown |
| **Categories** | `Audio & Music`, `Video` |
| **Website** | https://github.com/NDXDeveloper/3nity-media |
| **Contact** | Email de support |
| **License** | GPL-2.0 |

### 14. Ajouter des screenshots

- Format recommandé: 1280x720 ou 1920x1080 (16:9)
- Minimum 1 screenshot, recommandé 3-5
- Types: fenêtre principale, playlist, égaliseur, lecture vidéo

---

## Phase 6: Automatisation CI/CD

### 15. Configuration GitHub Actions

Le workflow `.github/workflows/build.yml` génère automatiquement le snap.

Pour publication automatique, ajouter les secrets GitHub:
- `SNAPCRAFT_STORE_CREDENTIALS`: Token d'authentification

```bash
# Générer le token
snapcraft export-login --snaps=3nity-media --acls=package_upload credentials.txt
# Copier le contenu dans les secrets GitHub
```

### 16. Exemple de job CI/CD

```yaml
- name: Publish to Snap Store
  env:
    SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}
  run: |
    snapcraft upload --release=edge 3nity-media_*.snap
```

---

## Phase 7: Maintenance

### Mettre à jour la version

1. Modifier `version` dans `snapcraft.yaml`
2. Rebuilder: `snapcraft`
3. Upload: `snapcraft upload --release=edge 3nity-media_X.Y_amd64.snap`
4. Tester sur edge
5. Promouvoir: `snapcraft release 3nity-media <revision> stable`

### Commandes utiles

```bash
# Voir les révisions publiées
snapcraft list-revisions 3nity-media

# Voir le statut des canaux
snapcraft status 3nity-media

# Voir les métriques
snapcraft metrics 3nity-media --name=installed_base_by_country

# Fermer un canal
snapcraft close 3nity-media edge
```

---

## Permissions (Plugs)

| Plug | Description |
|------|-------------|
| `home` | Accès au dossier home |
| `audio-playback` | Lecture audio |
| `audio-record` | Enregistrement audio (visualisations) |
| `pulseaudio` | Accès au serveur audio PulseAudio |
| `network` | Accès réseau (streaming) |
| `network-bind` | Serveur réseau (contrôle distant) |
| `removable-media` | Accès USB/média amovibles |
| `optical-drive` | Accès CD/DVD |
| `screen-inhibit-control` | Empêcher la mise en veille de l'écran |
| `unity7` | Intégration bureau Unity7 |
| `x11` | Affichage X11 |
| `wayland` | Affichage Wayland |
| `opengl` | Accélération GPU |
| `desktop` | Intégration desktop |
| `desktop-legacy` | Intégration desktop legacy |
| `gsettings` | Accès aux paramètres GNOME/GTK |
| `mount-observe` | Surveiller les événements de montage |

---

## Résolution de problèmes

### Le snap ne trouve pas libmpv

```bash
# Vérifier les stage-packages
snapcraft prime
ls prime/usr/lib/*/libmpv*
```

### Erreur de permission

```bash
# Connecter manuellement un plug
sudo snap connect 3nity-media:removable-media
```

### Debug du snap

```bash
# Lancer avec debug
snap run --shell 3nity-media
# Dans le shell:
$SNAP/bin/3nity-media
```

### Logs

```bash
# Voir les logs
journalctl --user -u snap.3nity-media.3nity-media
```

---

## Liens utiles

- [Documentation Snapcraft](https://snapcraft.io/docs)
- [Snap Store](https://snapcraft.io/store)
- [Dashboard développeur](https://snapcraft.io/snaps)
- [Forum Snapcraft](https://forum.snapcraft.io/)
- [Référence snapcraft.yaml](https://snapcraft.io/docs/snapcraft-yaml-reference)
