# Documentation Développeur - Versioning

Ce document décrit le système de versioning de 3nity Media, incluant la génération des versions, l'injection dans l'application et l'utilisation dans le code.

## Vue d'ensemble

3nity Media utilise un **système de versioning basé sur git** qui extrait automatiquement les informations de version depuis les tags et commits git, puis injecte ces informations dans le code source Pascal au moment de la compilation.

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Tags Git      │────▶│    Makefile     │────▶│  uVersion.inc   │
│   Commits Git   │     │                 │     │  (constantes)   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                                        │
                                                        ▼
                              ┌─────────────────────────────────────┐
                              │          uAppVersion.pas            │
                              │   (fonctions wrapper pour accès)    │
                              └─────────────────────────────────────┘
                                                        │
                                                        ▼
                              ┌─────────────────────────────────────┐
                              │       Application (UI, etc.)        │
                              │   Dialogue À propos, titre fenêtre  │
                              └─────────────────────────────────────┘
```

## Composants de Version

| Composant | Source | Exemple |
|-----------|--------|---------|
| `APP_VERSION` | `git describe --tags` | `v0.1.0` ou `v0.1.0-5-g1a2b3c4` |
| `APP_BUILD_DATE` | `date -u +%Y-%m-%d` | `2025-12-31` |
| `APP_BUILD_TIME` | `date -u +%H:%M:%S` | `16:47:48` |
| `APP_GIT_COMMIT` | `git rev-parse --short HEAD` | `1a2b3c4` |
| `APP_GIT_BRANCH` | `git rev-parse --abbrev-ref HEAD` | `main` |

### Format de la Chaîne de Version

`APP_VERSION` est dérivée de git en plusieurs formats :

| Scénario | Sortie de commande | Exemple |
|----------|-------------------|---------|
| Exactement sur un tag | `v0.1.0` | Version release |
| N commits après un tag | `v0.1.0-5-g1a2b3c4` | Version développement |
| Aucun tag existant | `1a2b3c4` | Hash du commit uniquement |
| Modifications non commitées | `v0.1.0-dirty` | Arbre de travail modifié |
| Pas un dépôt git | `dev` | Valeur de repli |

## Structure des Fichiers

### Fichiers Source

| Fichier | Objectif |
|---------|----------|
| `src/Core/uVersion.inc` | Constantes auto-générées (NE PAS MODIFIER) |
| `src/Core/uAppVersion.pas` | Unité wrapper avec fonctions utilitaires |

### Fichiers de Build

| Fichier | Objectif |
|---------|----------|
| `Makefile` | Génère `uVersion.inc` et compile l'application |

## Cibles Makefile

### Commandes de Version

```bash
# Afficher les informations de version actuelles
make version

# Générer/mettre à jour uVersion.inc sans compiler
make version-file

# Compiler avec injection automatique de version (recommandé)
make build-app      # Mode Debug
make build-release  # Mode Release (optimisé)

# Compiler avec une version spécifique
make release V=0.1.0
```

### Exemple de Sortie

```bash
$ make version
3nity Media - Informations de version
  Version:    v0.1.0
  Date:       2025-12-31
  Heure:      16:47:48
  Commit:     1a2b3c4
  Branche:    main
```

## Fichier Généré : uVersion.inc

Le Makefile génère `src/Core/uVersion.inc` :

```pascal
{ Auto-generated by Makefile - DO NOT EDIT }
{ Generated: 2025-12-31 16:47:48 }

const
  APP_VERSION = 'v0.1.0';
  APP_BUILD_DATE = '2025-12-31';
  APP_BUILD_TIME = '16:47:48';
  APP_GIT_COMMIT = '1a2b3c4';
  APP_GIT_BRANCH = 'main';
```

**Important :** Ce fichier est auto-généré. Ne jamais le modifier manuellement.

## Unité Wrapper : uAppVersion.pas

L'unité `uAppVersion` fournit des fonctions pratiques pour accéder aux informations de version :

### Fonctions Disponibles

| Fonction | Retourne | Exemple de Sortie |
|----------|----------|-------------------|
| `GetAppName` | Nom de l'application | `3nity Media` |
| `GetAppVersion` | Version avec préfixe 'v' | `v0.1.0` |
| `GetAppVersionShort` | Version sans 'v' | `0.1.0` |
| `GetAppFullVersion` | Nom + version | `3nity Media v0.1.0` |
| `GetBuildDate` | Date de build | `2025-12-31` |
| `GetBuildTime` | Heure de build | `16:47:48` |
| `GetBuildDateTime` | Date + heure | `2025-12-31 16:47:48` |
| `GetGitCommit` | Hash court du commit | `1a2b3c4` |
| `GetGitBranch` | Nom de la branche | `main` |
| `GetBuildInfo` | Détails complets du build | `Built: 2025-12-31 16:47:48 \| Commit: 1a2b3c4 (main)` |
| `GetFullVersionInfo` | Version + commit | `v0.1.0 (1a2b3c4)` |
| `GetVersionForTitle` | Format titre fenêtre | `3nity Media v0.1.0` |
| `GetVersionForAbout` | Multi-lignes pour dialogues | Bloc complet d'infos version |

### Exemple d'Utilisation

```pascal
uses
  uAppVersion;

procedure TfrmMain.FormCreate(Sender: TObject);
begin
  Caption := GetVersionForTitle;  // "3nity Media v0.1.0"
end;

procedure TfrmAbout.ShowInfo;
begin
  lblVersion.Caption := 'Version ' + GetFullVersionInfo;  // "Version v0.1.0 (1a2b3c4)"
  lblBuild.Caption := GetBuildInfo;  // "Built: 2025-12-31 16:47:48 | Commit: 1a2b3c4 (main)"
end;
```

## Gestion de Version CI/CD

Dans GitHub Actions (`build.yml`), la version est extraite différemment :

### Pour les Releases Taguées

```yaml
# Extraire la version du tag (ex: v0.1.0 → 0.1.0)
VERSION=${GITHUB_REF#refs/tags/}
VERSION=${VERSION#v}
```

### Pour les Builds de Développement

```yaml
# Générer une version dev : 0.0.0-dev.AAAAMMJJ.COMMIT
VERSION="0.0.0-dev.$(date +%Y%m%d).${GITHUB_SHA::7}"
```

### Nommage des Paquets

Tous les paquets incluent la version dans leur nom de fichier :

| Plateforme | Modèle de Paquet |
|------------|------------------|
| Linux DEB | `3nity-media_VERSION_amd64.deb` |
| AppImage | `3nity-Media-VERSION-x86_64.AppImage` |
| Snap | `3nity-media_VERSION_amd64.snap` |
| Windows Installeur | `3nity-Media-Setup-VERSION.exe` |
| Windows Portable | `3nity-media-windows-portable-VERSION.zip` |

## Créer une Nouvelle Release

### Étape 1 : Taguer la Release

```bash
# Créer un tag annoté
git tag -a v0.2.0 -m "Release 0.2.0: Nouvelles fonctionnalités..."

# Pousser le tag pour déclencher CI/CD
git push origin v0.2.0
```

### Étape 2 : Build Local (Optionnel)

```bash
# Compiler la release localement
make release V=0.2.0

# Sortie : releases/3nity-0.2.0-linux-x64
```

### Étape 3 : Build Automatique CI/CD

Quand un tag est poussé :
1. CI/CD extrait la version du tag
2. Compile pour Linux et Windows
3. Crée une Release GitHub avec tous les paquets

## Affichage de la Version dans l'Application

### Titre de Fenêtre
Utilise `GetVersionForTitle` :
```
3nity Media v0.1.0
```

### Dialogue À Propos
Utilise plusieurs fonctions :
- Ligne version : `GetFullVersionInfo` → `v0.1.0 (1a2b3c4)`
- Info build : `GetBuildDateTime` → `2025-12-31 16:47:48`
- Info compilateur : `GetGitCommit` → `1a2b3c4`

## Dépannage

### Valeurs "unknown" dans la Version

Si `APP_GIT_COMMIT` ou `APP_GIT_BRANCH` affiche "unknown" :
- Le build a été fait en dehors d'un dépôt git
- Git n'est pas installé sur le système de build
- Le répertoire `.git` est manquant

### Version Non Mise à Jour

1. Assurez-vous d'utiliser `make build-app` (pas `lazbuild` directement)
2. Vérifiez que `uVersion.inc` a été régénéré
3. Forcer la régénération : `make version-file`

### Problèmes de Version CI/CD

- Assurez-vous que les tags suivent le format `vX.Y.Z`
- Vérifiez que le tag est poussé : `git push origin --tags`
- Vérifiez le déclencheur du workflow dans `build.yml`

## Bonnes Pratiques

1. **Toujours utiliser le Makefile** pour les builds afin d'assurer l'injection de version
2. **Utiliser le versioning sémantique** (vMAJEUR.MINEUR.PATCH)
3. **Créer des tags annotés** avec l'option `-a` pour les releases
4. **Ne jamais modifier uVersion.inc manuellement** - il sera écrasé
5. **Utiliser les fonctions uAppVersion** plutôt que d'accéder directement aux constantes

## Informations de Version

- **Dernière mise à jour :** 2026-01-01
- **S'applique à :** 3nity Media v0.x et versions ultérieures
