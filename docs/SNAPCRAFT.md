# Publishing to the Snap Store

This guide details the steps to publish 3nity Media on the Snap Store (Snapcraft).

---

## Prerequisites

### Installing Snapcraft

```bash
sudo snap install snapcraft --classic
```

### Snapcraft Account

1. Create an account at https://snapcraft.io/account
2. Login locally:
```bash
snapcraft login
```

---

## Phase 1: Project Preparation

### 1. Snap File Structure

```
snap/
├── snapcraft.yaml              # Main manifest
└── gui/
    ├── 3nity-media.desktop     # Desktop file
    ├── 3nity-media.png         # Main icon (256x256)
    ├── 3nity-media-16.png      # 16x16 icon
    ├── 3nity-media-24.png      # 24x24 icon
    ├── 3nity-media-32.png      # 32x32 icon
    ├── 3nity-media-48.png      # 48x48 icon
    ├── 3nity-media-64.png      # 64x64 icon
    ├── 3nity-media-128.png     # 128x128 icon
    └── 3nity-media-256.png     # 256x256 icon
```

### 2. snapcraft.yaml File

```yaml
name: 3nity-media
base: core22
version: '0.1.0'
summary: Modern multimedia player based on libmpv
description: |
  3nity Media is a powerful and elegant multimedia player for Linux,
  built with Lazarus/Free Pascal and powered by libmpv.

  Features:
  - Video playback with hardware acceleration (VA-API, VDPAU)
  - Audio playback with 10-band equalizer
  - DVD and Blu-ray navigation support
  - Internet radio with Icecast directory
  - Playlist management (M3U, M3U8, PLS)
  - Customizable keyboard shortcuts
  - Multi-language interface (100+ languages)
  - Stream recording
  - Audio visualizations
  - Bookmarks and favorites
  - Session restore

  Supported formats: AVI, MKV, MP4, MOV, WMV, FLV, WebM, MP3, FLAC,
  OGG, Opus, AAC, WAV, and many more via libmpv/ffmpeg.

grade: stable
confinement: strict

icon: snap/gui/3nity-media.png

architectures:
  - build-on: amd64

apps:
  3nity-media:
    command: bin/3nity-media
    desktop: share/applications/3nity-media.desktop
    extensions:
      - kde-neon
    plugs:
      - home
      - audio-playback
      - audio-record
      - pulseaudio
      - network
      - network-bind
      - removable-media
      - optical-drive
      - screen-inhibit-control
      - unity7
      - x11
      - wayland
      - opengl
      - desktop
      - desktop-legacy
      - gsettings
      - mount-observe
    environment:
      LD_LIBRARY_PATH: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/pulseaudio:$LD_LIBRARY_PATH
      LIBVA_DRIVER_NAME: ""
      __EGL_VENDOR_LIBRARY_DIRS: $SNAP/usr/share/glvnd/egl_vendor.d

layout:
  /usr/share/libdrm:
    bind: $SNAP/usr/share/libdrm
  /usr/lib/$SNAPCRAFT_ARCH_TRIPLET/dri:
    bind: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/dri

parts:
  # Build dependencies - Lazarus IDE
  lazarus:
    plugin: nil
    build-packages:
      - lazarus-ide-qt5
      - lazarus-src
      - lcl-qt5
      - lcl-utils
      - fpc
      - fpc-source
    stage-packages:
      - libqt5pas1
    prime:
      - usr/lib/*/libQt5Pas*

  # Main application
  3nity-media:
    after: [lazarus]
    plugin: nil
    source: .
    build-packages:
      - lazarus-ide-qt5
      - lcl-qt5
      - fpc
      - libmpv-dev
      - libqt5pas-dev
    stage-packages:
      - libmpv2
      - libqt5pas1
      - ffmpeg
      - libva2
      - libva-drm2
      - libva-x11-2
      - libvdpau1
      - mesa-va-drivers
      - mesa-vdpau-drivers
      - libdrm2
      - libdrm-common
      - libegl1
      - libgl1
      - libglx0
      - libglvnd0
      - libpulse0
      - libasound2
      - liblua5.1-0
      - libass9
      - libbluray2
      - libcdio-paranoia2
      - libdvdnav4
      - libdvdread8
      - libjpeg8
      - libplacebo192
      - librubberband2
      - libsdl2-2.0-0
      - libsixel1
      - libsmbclient
      - libuchardet0
      - libxkbcommon0
      - libxss1
      - libzimg2
      - yt-dlp
    override-build: |
      # Generate version file
      VERSION="${SNAPCRAFT_PROJECT_VERSION}"
      BUILD_DATE=$(date -u +%Y-%m-%d)
      BUILD_TIME=$(date -u +%H:%M:%S)
      GIT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "snap")
      GIT_BRANCH="snap"

      mkdir -p src/Core
      cat > src/Core/uVersion.inc << EOF
      { Auto-generated by snapcraft - DO NOT EDIT }
      { Generated: ${BUILD_DATE} ${BUILD_TIME} }

      const
        APP_VERSION = '${VERSION}';
        APP_BUILD_DATE = '${BUILD_DATE}';
        APP_BUILD_TIME = '${BUILD_TIME}';
        APP_GIT_COMMIT = '${GIT_COMMIT}';
        APP_GIT_BRANCH = '${GIT_BRANCH}';
      EOF

      # Build the application in Release mode
      cd src
      lazbuild --build-mode=Release TrinityMedia.lpi

      # Install binary
      mkdir -p $SNAPCRAFT_PART_INSTALL/bin
      cp ../bin/x86_64-linux/3nity-media $SNAPCRAFT_PART_INSTALL/bin/

      # Install locale files from resources/locale/
      mkdir -p $SNAPCRAFT_PART_INSTALL/share/3nity-media/locale
      if [ -d "../resources/locale" ]; then
        cp ../resources/locale/*.lang $SNAPCRAFT_PART_INSTALL/share/3nity-media/locale/
      fi

      # Install LICENSE and documentation
      mkdir -p $SNAPCRAFT_PART_INSTALL/share/doc/3nity-media
      cp ../LICENSE $SNAPCRAFT_PART_INSTALL/share/doc/3nity-media/ || true
      cp ../README.md $SNAPCRAFT_PART_INSTALL/share/doc/3nity-media/ || true
    prime:
      - bin/3nity-media
      - share/3nity-media/
      - share/doc/3nity-media/
      - usr/lib/*/libmpv*
      - usr/lib/*/libQt5Pas*
      - usr/lib/*/libass*
      - usr/lib/*/libbluray*
      - usr/lib/*/libdvd*
      - usr/lib/*/libva*
      - usr/lib/*/libvdpau*
      - usr/lib/*/libplacebo*
      - usr/lib/*/librubberband*
      - usr/lib/*/libpulse*
      - usr/lib/*/libasound*
      - usr/lib/*/dri/
      - usr/bin/ffprobe
      - usr/bin/yt-dlp
      - usr/share/libdrm/

  # Desktop integration files
  desktop-files:
    plugin: dump
    source: snap/gui
    organize:
      3nity-media.desktop: share/applications/3nity-media.desktop
      3nity-media-16.png: share/icons/hicolor/16x16/apps/3nity-media.png
      3nity-media-24.png: share/icons/hicolor/24x24/apps/3nity-media.png
      3nity-media-32.png: share/icons/hicolor/32x32/apps/3nity-media.png
      3nity-media-48.png: share/icons/hicolor/48x48/apps/3nity-media.png
      3nity-media-64.png: share/icons/hicolor/64x64/apps/3nity-media.png
      3nity-media-128.png: share/icons/hicolor/128x128/apps/3nity-media.png
      3nity-media-256.png: share/icons/hicolor/256x256/apps/3nity-media.png

  # Cleanup
  cleanup:
    after: [3nity-media, desktop-files]
    plugin: nil
    override-prime: |
      set -eux
      # Remove unnecessary files to reduce snap size
      rm -rf usr/share/doc
      rm -rf usr/share/man
      rm -rf usr/share/lintian
      rm -rf usr/share/bug
      rm -rf usr/lib/*/cmake
      rm -rf usr/lib/*/pkgconfig
      find . -name "*.a" -delete
      find . -name "*.la" -delete
```

### 3. Desktop File (snap/gui/3nity-media.desktop)

```ini
[Desktop Entry]
Version=1.0
Type=Application
Name=3nity Media
GenericName=Media Player
Comment=Modern multimedia player powered by libmpv
Exec=3nity-media %F
Icon=${SNAP}/meta/gui/3nity-media.png
Terminal=false
Categories=AudioVideo;Audio;Video;Player;
MimeType=audio/*;video/*;
Keywords=media;player;audio;video;music;movie;stream;radio;
```

---

## Phase 2: Local Build

### 4. Compile the application

```bash
# Ensure the binary is compiled
make build-release
```

### 5. Prepare the icons

```bash
mkdir -p snap/gui

# Copy icons
for size in 16 24 32 48 64 128 256; do
  cp resources/icons/${size}x${size}.png snap/gui/3nity-media-${size}.png
done
cp resources/icons/256x256.png snap/gui/3nity-media.png
```

### 6. Build the snap locally

```bash
# Build with LXD (recommended)
snapcraft

# Or destructive build (modifies host system)
snapcraft --destructive-mode
```

### 7. Test the snap locally

```bash
# Install the local snap
sudo snap install --dangerous 3nity-media_0.1.0_amd64.snap

# Run the application
snap run 3nity-media

# Check connections (permissions)
snap connections 3nity-media

# Uninstall
sudo snap remove 3nity-media
```

---

## Phase 3: Name Registration

### 8. Reserve the name on the Snap Store

```bash
snapcraft register 3nity-media
```

> **Note:** The name must be unique on the Snap Store. If already taken, choose a variant.

### 9. Verify registration

```bash
snapcraft list-registered
```

---

## Phase 4: Publishing

### 10. Push the snap to the Store

```bash
# Upload to the edge channel (testing)
snapcraft upload --release=edge 3nity-media_0.1.0_amd64.snap

# Or upload without immediate release
snapcraft upload 3nity-media_0.1.0_amd64.snap
```

### 11. Distribution Channels

| Channel | Usage |
|---------|-------|
| `edge` | Automatic builds, very unstable |
| `beta` | Public testing, may have bugs |
| `candidate` | Release candidate, final testing |
| `stable` | Production, stable version |

### 12. Promote to stable

```bash
# Via command line
snapcraft release 3nity-media 1 stable

# Where "1" is the revision number (shown after upload)
```

---

## Phase 5: Store Configuration

### 13. Configure the Store page

Go to https://snapcraft.io/3nity-media/listing and configure:

| Element | Description |
|---------|-------------|
| **Icon** | 256x256 PNG or SVG logo |
| **Banner** | 1920x480 image for banner |
| **Screenshots** | Screenshots (1280x720 recommended) |
| **Description** | Detailed Markdown description |
| **Categories** | `Audio & Music`, `Video` |
| **Website** | https://github.com/NDXDeveloper/3nity-media |
| **Contact** | Support email |
| **License** | GPL-2.0 |

### 14. Add screenshots

- Recommended format: 1280x720 or 1920x1080 (16:9)
- Minimum 1 screenshot, recommended 3-5
- Types: main window, playlist, equalizer, video playback

---

## Phase 6: CI/CD Automation

### 15. GitHub Actions Configuration

The `.github/workflows/build.yml` workflow automatically generates the snap.

For automatic publishing, add GitHub secrets:
- `SNAPCRAFT_STORE_CREDENTIALS`: Authentication token

```bash
# Generate the token
snapcraft export-login --snaps=3nity-media --acls=package_upload credentials.txt
# Copy the content to GitHub secrets
```

### 16. Example CI/CD Job

```yaml
- name: Publish to Snap Store
  env:
    SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}
  run: |
    snapcraft upload --release=edge 3nity-media_*.snap
```

---

## Phase 7: Maintenance

### Update the version

1. Modify `version` in `snapcraft.yaml`
2. Rebuild: `snapcraft`
3. Upload: `snapcraft upload --release=edge 3nity-media_X.Y_amd64.snap`
4. Test on edge
5. Promote: `snapcraft release 3nity-media <revision> stable`

### Useful Commands

```bash
# View published revisions
snapcraft list-revisions 3nity-media

# View channel status
snapcraft status 3nity-media

# View metrics
snapcraft metrics 3nity-media --name=installed_base_by_country

# Close a channel
snapcraft close 3nity-media edge
```

---

## Permissions (Plugs)

| Plug | Description |
|------|-------------|
| `home` | Access to home folder |
| `audio-playback` | Audio playback |
| `audio-record` | Audio recording (visualizations) |
| `pulseaudio` | PulseAudio sound server access |
| `network` | Network access (streaming) |
| `network-bind` | Network server (remote control) |
| `removable-media` | USB/removable media access |
| `optical-drive` | CD/DVD access |
| `screen-inhibit-control` | Prevent screen sleep during playback |
| `unity7` | Unity7 desktop integration |
| `x11` | X11 display |
| `wayland` | Wayland display |
| `opengl` | GPU acceleration |
| `desktop` | Desktop integration |
| `desktop-legacy` | Legacy desktop integration |
| `gsettings` | GNOME/GTK settings access |
| `mount-observe` | Monitor mount events |

---

## Troubleshooting

### Snap can't find libmpv

```bash
# Check stage-packages
snapcraft prime
ls prime/usr/lib/*/libmpv*
```

### Permission error

```bash
# Manually connect a plug
sudo snap connect 3nity-media:removable-media
```

### Debug the snap

```bash
# Run with debug
snap run --shell 3nity-media
# In the shell:
$SNAP/bin/3nity-media
```

### Logs

```bash
# View logs
journalctl --user -u snap.3nity-media.3nity-media
```

---

## Useful Links

- [Snapcraft Documentation](https://snapcraft.io/docs)
- [Snap Store](https://snapcraft.io/store)
- [Developer Dashboard](https://snapcraft.io/snaps)
- [Snapcraft Forum](https://forum.snapcraft.io/)
- [snapcraft.yaml Reference](https://snapcraft.io/docs/snapcraft-yaml-reference)
