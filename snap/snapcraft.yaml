name: 3nity-media
base: core24
version: git
summary: Modern multimedia player based on libmpv
description: |
  3nity Media is a powerful and elegant multimedia player for Linux,
  built with Lazarus/Free Pascal and powered by libmpv.

  Features:
  - Video playback with hardware acceleration (VA-API, VDPAU)
  - Audio playback with 10-band equalizer
  - DVD and Blu-ray navigation support
  - Internet radio with Icecast directory
  - Playlist management (M3U, M3U8, PLS)
  - Customizable keyboard shortcuts
  - Multi-language interface (100+ languages)
  - Stream recording
  - Audio visualizations
  - Bookmarks and favorites
  - Session restore

  Supported formats: AVI, MKV, MP4, MOV, WMV, FLV, WebM, MP3, FLAC,
  OGG, Opus, AAC, WAV, and many more via libmpv/ffmpeg.

grade: stable
confinement: strict

icon: snap/gui/3nity-media.png

platforms:
  amd64:
    build-on: [amd64]
    build-for: [amd64]

apps:
  3nity-media:
    extensions: [kde-neon]
    command: bin/3nity-media
    desktop: share/applications/3nity-media.desktop
    plugs:
      - home
      - audio-playback
      - audio-record
      - pulseaudio
      - network
      - network-bind
      - removable-media
      - optical-drive
      - screen-inhibit-control
      - unity7
      - x11
      - wayland
      - opengl
      - desktop
      - desktop-legacy
      - gsettings
      - mount-observe
      - udisks2
    environment:
      LD_LIBRARY_PATH: $SNAP/usr/lib:$SNAP/usr/lib/x86_64-linux-gnu:$SNAP/usr/lib/x86_64-linux-gnu/pulseaudio:$SNAP/usr/lib/x86_64-linux-gnu/blas:$SNAP/usr/lib/x86_64-linux-gnu/lapack:$LD_LIBRARY_PATH
      UBUNTU_MENUPROXY: ""
      QT_QPA_PLATFORM: xcb

layout:
  /usr/share/libdrm:
    bind: $SNAP/usr/share/libdrm
  /usr/lib/x86_64-linux-gnu/dri:
    bind: $SNAP/usr/lib/x86_64-linux-gnu/dri

parts:
  # Build dependencies - Lazarus IDE
  lazarus:
    plugin: nil
    build-packages:
      - lazarus-ide-qt5
      - lazarus-src
      - lcl-qt5
      - lcl-utils
      - fpc
      - fpc-source
    stage-packages:
      - libqt5pas1
    prime:
      - usr/lib/*/libQt5Pas*

  # Main application
  3nity-media:
    after: [lazarus]
    plugin: nil
    source: .
    build-packages:
      - lazarus-ide-qt5
      - lcl-qt5
      - fpc
      - libmpv-dev
      - libqt5pas-dev
    stage-packages:
      - libmpv2
      - libqt5pas1
      - ffmpeg
      - libva2
      - libva-drm2
      - libva-x11-2
      - libvdpau1
      - mesa-va-drivers
      - mesa-vdpau-drivers
      - libdrm2
      - libdrm-common
      - libegl1
      - libgl1
      - libglx0
      - libglvnd0
      - libpulse0
      - libpulse-mainloop-glib0
      - libasound2
      - liblua5.1-0
      - libass9
      - libbluray2
      - libcdio-paranoia2
      - libdvdnav4
      - libdvdread8
      - libjpeg8
      - librubberband2
      - libsdl2-2.0-0
      - libsixel1
      - libsmbclient
      - libuchardet0
      - libxkbcommon0
      - libxss1
      - libzimg2
      - libblas3
      - liblapack3
      - plasma-integration
      - qt5-style-plugins
      - breeze-icon-theme
      - kde-style-breeze
      - yt-dlp
    override-build: |
      # Generate version file
      VERSION="${SNAPCRAFT_PROJECT_VERSION}"
      BUILD_DATE=$(date -u +%Y-%m-%d)
      BUILD_TIME=$(date -u +%H:%M:%S)
      GIT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "snap")
      GIT_BRANCH="snap"

      mkdir -p src/Core
      cat > src/Core/uVersion.inc << EOF
      { Auto-generated by snapcraft - DO NOT EDIT }
      { Generated: ${BUILD_DATE} ${BUILD_TIME} }

      const
        APP_VERSION = '${VERSION}';
        APP_BUILD_DATE = '${BUILD_DATE}';
        APP_BUILD_TIME = '${BUILD_TIME}';
        APP_GIT_COMMIT = '${GIT_COMMIT}';
        APP_GIT_BRANCH = '${GIT_BRANCH}';
      EOF

      # Build the application in Release mode
      cd src
      lazbuild --build-mode=Release TrinityMedia.lpi

      # Install binary
      mkdir -p $SNAPCRAFT_PART_INSTALL/bin
      cp ../bin/x86_64-linux/3nity-media $SNAPCRAFT_PART_INSTALL/bin/

      # Install locale files from resources/locale/
      mkdir -p $SNAPCRAFT_PART_INSTALL/share/3nity-media/locale
      if [ -d "../resources/locale" ]; then
        cp ../resources/locale/*.lang $SNAPCRAFT_PART_INSTALL/share/3nity-media/locale/
        echo "Copied $(ls -1 $SNAPCRAFT_PART_INSTALL/share/3nity-media/locale/*.lang | wc -l) locale files"
      fi

      # Install LICENSE and documentation
      mkdir -p $SNAPCRAFT_PART_INSTALL/share/doc/3nity-media
      cp ../LICENSE $SNAPCRAFT_PART_INSTALL/share/doc/3nity-media/ || true
      cp ../README.md $SNAPCRAFT_PART_INSTALL/share/doc/3nity-media/ || true

  # Desktop integration files
  desktop-files:
    plugin: dump
    source: snap/gui
    organize:
      3nity-media.desktop: share/applications/3nity-media.desktop
      3nity-media-16.png: share/icons/hicolor/16x16/apps/3nity-media.png
      3nity-media-24.png: share/icons/hicolor/24x24/apps/3nity-media.png
      3nity-media-32.png: share/icons/hicolor/32x32/apps/3nity-media.png
      3nity-media-48.png: share/icons/hicolor/48x48/apps/3nity-media.png
      3nity-media-64.png: share/icons/hicolor/64x64/apps/3nity-media.png
      3nity-media-128.png: share/icons/hicolor/128x128/apps/3nity-media.png
      3nity-media-256.png: share/icons/hicolor/256x256/apps/3nity-media.png

  # Cleanup
  cleanup:
    after: [3nity-media, desktop-files]
    plugin: nil
    override-prime: |
      set -eux
      # Remove unnecessary files to reduce snap size
      rm -rf usr/share/doc
      rm -rf usr/share/man
      rm -rf usr/share/lintian
      rm -rf usr/share/bug
      rm -rf usr/lib/*/cmake
      rm -rf usr/lib/*/pkgconfig
      find . -name "*.a" -delete
      find . -name "*.la" -delete
