# .github/workflows/check-linux-deps.yml
# Checks availability of Linux dependencies (libmpv, libqt5pas, ffprobe)
name: Check Linux Dependencies

on:
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6:00 UTC
  workflow_dispatch:      # Manual trigger

jobs:
  # ==========================================================================
  # CHECK DEPENDENCIES
  # ==========================================================================
  check-deps:
    name: Check Linux Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: Check APT packages availability
      id: check-apt
      run: |
        echo "=== Checking APT packages availability ==="

        sudo apt-get update

        # Check libmpv (either version)
        echo "Checking libmpv..."
        if apt-cache show libmpv2 &>/dev/null; then
          echo "✓ libmpv2: available"
          echo "libmpv_status=ok" >> $GITHUB_OUTPUT
          echo "libmpv_version=libmpv2" >> $GITHUB_OUTPUT
        elif apt-cache show libmpv1 &>/dev/null; then
          echo "✓ libmpv1: available"
          echo "libmpv_status=ok" >> $GITHUB_OUTPUT
          echo "libmpv_version=libmpv1" >> $GITHUB_OUTPUT
        else
          echo "✗ libmpv: NOT FOUND"
          echo "libmpv_status=failed" >> $GITHUB_OUTPUT
        fi

        # Check libqt5pas
        echo "Checking libqt5pas..."
        if apt-cache show libqt5pas1 &>/dev/null; then
          echo "✓ libqt5pas1: available"
          echo "libqt5pas_status=ok" >> $GITHUB_OUTPUT
        else
          echo "✗ libqt5pas: NOT FOUND"
          echo "libqt5pas_status=failed" >> $GITHUB_OUTPUT
        fi

        # Check ffmpeg
        echo "Checking ffmpeg..."
        if apt-cache show ffmpeg &>/dev/null; then
          echo "✓ ffmpeg: available"
          echo "ffmpeg_status=ok" >> $GITHUB_OUTPUT
        else
          echo "✗ ffmpeg: NOT FOUND"
          echo "ffmpeg_status=failed" >> $GITHUB_OUTPUT
        fi

        # Check lazarus
        echo "Checking lazarus..."
        if apt-cache show lazarus-ide-qt5 &>/dev/null; then
          echo "✓ lazarus-ide-qt5: available"
          echo "lazarus_status=ok" >> $GITHUB_OUTPUT
        else
          echo "✗ lazarus-ide-qt5: NOT FOUND"
          echo "lazarus_status=failed" >> $GITHUB_OUTPUT
        fi

    - name: Test APT installation
      id: test-install
      run: |
        echo "=== Testing APT installation ==="

        # Install packages
        sudo apt-get install -y libmpv2 || sudo apt-get install -y libmpv1
        sudo apt-get install -y libqt5pas1
        sudo apt-get install -y ffmpeg

        # Verify installations
        echo "Checking installed libraries..."

        # Check libmpv
        LIBMPV=$(ldconfig -p | grep libmpv || true)
        if [ -n "$LIBMPV" ]; then
          echo "✓ libmpv installed"
          echo "$LIBMPV"
          echo "libmpv_installed=ok" >> $GITHUB_OUTPUT
        else
          echo "✗ libmpv: installation failed"
          echo "libmpv_installed=failed" >> $GITHUB_OUTPUT
        fi

        # Check libqt5pas
        LIBQT5PAS=$(ldconfig -p | grep -i qt5pas || true)
        if [ -n "$LIBQT5PAS" ]; then
          echo "✓ libqt5pas installed"
          echo "$LIBQT5PAS"
          echo "libqt5pas_installed=ok" >> $GITHUB_OUTPUT
        else
          echo "✗ libqt5pas: installation failed"
          echo "libqt5pas_installed=failed" >> $GITHUB_OUTPUT
        fi

        # Check ffprobe
        if which ffprobe &>/dev/null; then
          echo "✓ ffprobe installed"
          ffprobe -version | head -1
          echo "ffprobe_installed=ok" >> $GITHUB_OUTPUT
        else
          echo "✗ ffprobe: installation failed"
          echo "ffprobe_installed=failed" >> $GITHUB_OUTPUT
        fi

    - name: Check AppImage tools availability
      id: check-appimage
      run: |
        echo "=== Checking AppImage tools availability ==="

        # Check linuxdeploy
        LINUXDEPLOY_URL="https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"
        echo "Testing linuxdeploy: $LINUXDEPLOY_URL"
        HTTP_CODE=$(curl -sIL "$LINUXDEPLOY_URL" -o /dev/null -w "%{http_code}" --max-time 30)
        if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
          echo "✓ linuxdeploy: available (HTTP $HTTP_CODE)"
          echo "linuxdeploy=ok" >> $GITHUB_OUTPUT
        else
          echo "✗ linuxdeploy: FAILED (HTTP $HTTP_CODE)"
          echo "linuxdeploy=failed" >> $GITHUB_OUTPUT
        fi

        # Check linuxdeploy-plugin-qt
        QT_PLUGIN_URL="https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage"
        echo "Testing linuxdeploy-plugin-qt: $QT_PLUGIN_URL"
        HTTP_CODE=$(curl -sIL "$QT_PLUGIN_URL" -o /dev/null -w "%{http_code}" --max-time 30)
        if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
          echo "✓ linuxdeploy-plugin-qt: available (HTTP $HTTP_CODE)"
          echo "linuxdeploy_qt=ok" >> $GITHUB_OUTPUT
        else
          echo "✗ linuxdeploy-plugin-qt: FAILED (HTTP $HTTP_CODE)"
          echo "linuxdeploy_qt=failed" >> $GITHUB_OUTPUT
        fi

    - name: Summary
      if: always()
      run: |
        echo "=== Linux Dependencies Check Summary ==="
        echo ""
        echo "APT Packages:"
        echo "  libmpv: ${{ steps.check-apt.outputs.libmpv_status || 'unknown' }} (${{ steps.check-apt.outputs.libmpv_version || 'N/A' }})"
        echo "  libqt5pas: ${{ steps.check-apt.outputs.libqt5pas_status || 'unknown' }}"
        echo "  ffmpeg: ${{ steps.check-apt.outputs.ffmpeg_status || 'unknown' }}"
        echo "  lazarus: ${{ steps.check-apt.outputs.lazarus_status || 'unknown' }}"
        echo ""
        echo "Installation Test:"
        echo "  libmpv: ${{ steps.test-install.outputs.libmpv_installed || 'unknown' }}"
        echo "  libqt5pas: ${{ steps.test-install.outputs.libqt5pas_installed || 'unknown' }}"
        echo "  ffprobe: ${{ steps.test-install.outputs.ffprobe_installed || 'unknown' }}"
        echo ""
        echo "AppImage Tools:"
        echo "  linuxdeploy: ${{ steps.check-appimage.outputs.linuxdeploy || 'unknown' }}"
        echo "  linuxdeploy-plugin-qt: ${{ steps.check-appimage.outputs.linuxdeploy_qt || 'unknown' }}"

  # ==========================================================================
  # CREATE ISSUE ON FAILURE
  # ==========================================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [check-deps]
    if: failure()

    steps:
    - name: Create GitHub Issue
      uses: actions/github-script@v7
      with:
        script: |
          const title = '⚠️ Linux Dependencies Check Failed';
          const body = `## Linux Dependencies Check Failed

          One or more Linux dependencies are unavailable or have changed.

          **Date:** ${new Date().toISOString()}
          **Workflow:** ${context.workflow}
          **Run:** ${context.runNumber}

          ### Action Required
          - Check APT package availability (libmpv, libqt5pas, ffmpeg, lazarus)
          - Check AppImage tool availability (linuxdeploy, linuxdeploy-plugin-qt)

          [View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
          `;

          // Check if similar issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'dependencies,automated'
          });

          const existingIssue = issues.data.find(i => i.title === title);

          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'automated', 'linux']
            });
            console.log('Issue created');
          } else {
            // Add comment to existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `### Check failed again\n\n**Date:** ${new Date().toISOString()}\n\n[View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });
            console.log('Comment added to existing issue');
          }
