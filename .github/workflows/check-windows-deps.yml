# .github/workflows/check-windows-deps.yml
# Checks availability of Windows dependencies (libmpv, ffprobe)
name: Check Windows Dependencies

on:
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6:00 UTC
  workflow_dispatch:      # Manual trigger

jobs:
  # ==========================================================================
  # CHECK DEPENDENCIES (using bash for reliability)
  # ==========================================================================
  check-deps:
    name: Check Windows Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: Check libmpv on GitHub (shinchiro/mpv-winbuild-cmake)
      id: check-libmpv
      run: |
        echo "=== Checking libmpv on GitHub ==="

        # Get latest release info from GitHub API
        RELEASE_INFO=$(curl -s "https://api.github.com/repos/shinchiro/mpv-winbuild-cmake/releases/latest")

        # Find mpv-dev-x86_64 asset
        MPV_URL=$(echo "$RELEASE_INFO" | grep -o '"browser_download_url": "[^"]*mpv-dev-x86_64[^"]*\.7z"' | head -1 | cut -d'"' -f4)

        if [ -n "$MPV_URL" ]; then
          echo "Found libmpv: $MPV_URL"

          # Test if downloadable
          HTTP_CODE=$(curl -sIL "$MPV_URL" -o /dev/null -w "%{http_code}" --max-time 30)

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "libmpv: OK (HTTP $HTTP_CODE)"
            echo "status=ok" >> $GITHUB_OUTPUT
            echo "url=$MPV_URL" >> $GITHUB_OUTPUT
          else
            echo "libmpv: FAILED (HTTP $HTTP_CODE)"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "ERROR: Could not find libmpv download URL"
          echo "Available assets:"
          echo "$RELEASE_INFO" | grep browser_download_url || echo "No assets found"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Check ffprobe on gyan.dev
      id: check-ffprobe
      run: |
        echo "=== Checking FFmpeg (ffprobe) on gyan.dev ==="
        FFMPEG_URL="https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"

        echo "Testing: $FFMPEG_URL"
        HTTP_CODE=$(curl -sIL "$FFMPEG_URL" -o /dev/null -w "%{http_code}" --max-time 30)

        if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
          echo "ffprobe: OK (HTTP $HTTP_CODE)"
          echo "status=ok" >> $GITHUB_OUTPUT
        else
          echo "ffprobe: FAILED (HTTP $HTTP_CODE)"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Test actual download and extraction
      id: test-download
      run: |
        echo "=== Testing actual download and extraction ==="

        mkdir -p deps

        # Download libmpv from GitHub
        echo "Downloading libmpv..."
        RELEASE_INFO=$(curl -s "https://api.github.com/repos/shinchiro/mpv-winbuild-cmake/releases/latest")
        MPV_URL=$(echo "$RELEASE_INFO" | grep -o '"browser_download_url": "[^"]*mpv-dev-x86_64[^"]*\.7z"' | head -1 | cut -d'"' -f4)

        curl -L -o deps/libmpv.7z "$MPV_URL"

        # Extract and verify
        sudo apt-get install -y p7zip-full
        7z x deps/libmpv.7z -odeps/libmpv -y

        # Check for DLL
        MPV_DLL=$(find deps/libmpv -name "libmpv*.dll" | head -1)
        if [ -n "$MPV_DLL" ]; then
          echo "libmpv DLL found: $MPV_DLL"
          ls -la "$MPV_DLL"
          echo "libmpv_extracted=ok" >> $GITHUB_OUTPUT
        else
          echo "ERROR: libmpv DLL not found in archive!"
          find deps/libmpv -type f
          echo "libmpv_extracted=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        # Download ffprobe
        echo "Downloading ffprobe..."
        curl -L -o deps/ffmpeg.zip "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"

        unzip -q deps/ffmpeg.zip -d deps/ffmpeg

        FFPROBE=$(find deps/ffmpeg -name "ffprobe.exe" | head -1)
        if [ -n "$FFPROBE" ]; then
          echo "ffprobe.exe found: $FFPROBE"
          ls -la "$FFPROBE"
          echo "ffprobe_extracted=ok" >> $GITHUB_OUTPUT
        else
          echo "ERROR: ffprobe.exe not found in archive!"
          echo "ffprobe_extracted=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "=== All downloads and extractions successful ==="

    - name: Summary
      if: always()
      run: |
        echo "=== Windows Dependencies Check Summary ==="
        echo "libmpv URL check: ${{ steps.check-libmpv.outputs.status || 'unknown' }}"
        echo "libmpv URL: ${{ steps.check-libmpv.outputs.url || 'N/A' }}"
        echo "ffprobe URL check: ${{ steps.check-ffprobe.outputs.status || 'unknown' }}"
        echo "libmpv extracted: ${{ steps.test-download.outputs.libmpv_extracted || 'unknown' }}"
        echo "ffprobe extracted: ${{ steps.test-download.outputs.ffprobe_extracted || 'unknown' }}"

  # ==========================================================================
  # CREATE ISSUE ON FAILURE
  # ==========================================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [check-deps]
    if: failure()

    steps:
    - name: Create GitHub Issue
      uses: actions/github-script@v7
      with:
        script: |
          const title = '⚠️ Windows Dependencies Check Failed';
          const body = `## Windows Dependencies Check Failed

          One or more Windows dependencies are unavailable or have changed.

          **Date:** ${new Date().toISOString()}
          **Workflow:** ${context.workflow}
          **Run:** ${context.runNumber}

          ### Action Required
          - Check GitHub shinchiro/mpv-winbuild-cmake releases for libmpv
          - Check gyan.dev ffprobe availability
          - Update download URLs if necessary

          [View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
          `;

          // Check if similar issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'dependencies,automated'
          });

          const existingIssue = issues.data.find(i => i.title === title);

          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'automated', 'windows']
            });
            console.log('Issue created');
          } else {
            // Add comment to existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `### Check failed again\n\n**Date:** ${new Date().toISOString()}\n\n[View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });
            console.log('Comment added to existing issue');
          }
