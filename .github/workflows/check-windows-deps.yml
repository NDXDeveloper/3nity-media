# .github/workflows/check-windows-deps.yml
# Checks availability of Windows dependencies (libmpv, ffprobe)
name: Check Windows Dependencies

on:
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6:00 UTC
  workflow_dispatch:      # Manual trigger

jobs:
  # ==========================================================================
  # CHECK WITH BASH (Linux runner)
  # ==========================================================================
  check-bash:
    name: Check with Bash
    runs-on: ubuntu-latest

    steps:
    - name: Check libmpv on SourceForge
      id: check-libmpv-bash
      run: |
        echo "=== Checking libmpv on SourceForge ==="
        SF_URL="https://sourceforge.net/projects/mpv-player-windows/files/libmpv/"

        # Get directory listing
        echo "Fetching directory listing..."
        PAGE=$(curl -sL "$SF_URL" --max-time 30)

        # Find latest mpv-dev-x86_64 file
        LATEST=$(echo "$PAGE" | grep -oP 'mpv-dev-x86_64-\d{8}-git-[a-f0-9]+\.7z' | head -1)

        if [ -n "$LATEST" ]; then
          echo "Found: $LATEST"
          DOWNLOAD_URL="${SF_URL}${LATEST}/download"
          echo "Testing download URL: $DOWNLOAD_URL"

          # Test if downloadable
          HTTP_CODE=$(curl -sIL "$DOWNLOAD_URL" -o /dev/null -w "%{http_code}" --max-time 30)

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "libmpv: OK (HTTP $HTTP_CODE)"
            echo "status=ok" >> $GITHUB_OUTPUT
            echo "file=$LATEST" >> $GITHUB_OUTPUT
          else
            echo "libmpv: FAILED (HTTP $HTTP_CODE)"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "ERROR: Could not find libmpv file in directory listing"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Check ffprobe on gyan.dev
      id: check-ffprobe-bash
      run: |
        echo "=== Checking FFmpeg (ffprobe) on gyan.dev ==="
        FFMPEG_URL="https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"

        echo "Testing: $FFMPEG_URL"
        HTTP_CODE=$(curl -sIL "$FFMPEG_URL" -o /dev/null -w "%{http_code}" --max-time 30)

        if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
          echo "ffprobe: OK (HTTP $HTTP_CODE)"
          echo "status=ok" >> $GITHUB_OUTPUT
        else
          echo "ffprobe: FAILED (HTTP $HTTP_CODE)"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Summary (Bash)
      if: always()
      run: |
        echo "=== Bash Check Summary ==="
        echo "libmpv: ${{ steps.check-libmpv-bash.outputs.status || 'unknown' }}"
        echo "libmpv file: ${{ steps.check-libmpv-bash.outputs.file || 'N/A' }}"
        echo "ffprobe: ${{ steps.check-ffprobe-bash.outputs.status || 'unknown' }}"

  # ==========================================================================
  # CHECK WITH POWERSHELL (Windows runner)
  # ==========================================================================
  check-powershell:
    name: Check with PowerShell
    runs-on: windows-latest

    steps:
    - name: Check libmpv on SourceForge
      id: check-libmpv-ps
      shell: pwsh
      run: |
        Write-Host "=== Checking libmpv on SourceForge ===" -ForegroundColor Cyan
        $sfBaseUrl = "https://sourceforge.net/projects/mpv-player-windows/files/libmpv/"

        try {
          Write-Host "Fetching directory listing..."
          $page = Invoke-WebRequest -Uri $sfBaseUrl -UserAgent "Mozilla/5.0" -TimeoutSec 30

          # Find latest mpv-dev-x86_64 file
          $pattern = 'mpv-dev-x86_64-\d{8}-git-[a-f0-9]+\.7z'
          $matches = [regex]::Matches($page.Content, $pattern)

          if ($matches.Count -gt 0) {
            $latestFile = $matches[0].Value
            Write-Host "Found: $latestFile" -ForegroundColor Green

            $downloadUrl = "${sfBaseUrl}${latestFile}/download"
            Write-Host "Testing download URL: $downloadUrl"

            # Test if downloadable
            $response = Invoke-WebRequest -Uri $downloadUrl -Method Head -UserAgent "Mozilla/5.0" -MaximumRedirection 10 -TimeoutSec 30

            if ($response.StatusCode -eq 200) {
              Write-Host "libmpv: OK (Status: $($response.StatusCode))" -ForegroundColor Green
              "status=ok" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              "file=$latestFile" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            } else {
              Write-Host "libmpv: FAILED (Status: $($response.StatusCode))" -ForegroundColor Red
              "status=failed" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              exit 1
            }
          } else {
            Write-Host "ERROR: Could not find libmpv file in directory listing" -ForegroundColor Red
            "status=failed" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 1
          }
        } catch {
          Write-Host "ERROR: $($_.Exception.Message)" -ForegroundColor Red
          "status=failed" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          exit 1
        }

    - name: Check ffprobe on gyan.dev
      id: check-ffprobe-ps
      shell: pwsh
      run: |
        Write-Host "=== Checking FFmpeg (ffprobe) on gyan.dev ===" -ForegroundColor Cyan
        $ffmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"

        try {
          Write-Host "Testing: $ffmpegUrl"
          $response = Invoke-WebRequest -Uri $ffmpegUrl -Method Head -TimeoutSec 30

          if ($response.StatusCode -eq 200) {
            Write-Host "ffprobe: OK (Status: $($response.StatusCode))" -ForegroundColor Green
            "status=ok" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            Write-Host "ffprobe: FAILED (Status: $($response.StatusCode))" -ForegroundColor Red
            "status=failed" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 1
          }
        } catch {
          Write-Host "ERROR: $($_.Exception.Message)" -ForegroundColor Red
          "status=failed" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          exit 1
        }

    - name: Test actual download and extraction
      id: test-download
      shell: pwsh
      run: |
        Write-Host "=== Testing actual download and extraction ===" -ForegroundColor Cyan

        New-Item -ItemType Directory -Force -Path "deps" | Out-Null

        # Download libmpv
        Write-Host "Downloading libmpv..."
        $sfBaseUrl = "https://sourceforge.net/projects/mpv-player-windows/files/libmpv/"
        $page = Invoke-WebRequest -Uri $sfBaseUrl -UserAgent "Mozilla/5.0"
        $pattern = 'mpv-dev-x86_64-\d{8}-git-[a-f0-9]+\.7z'
        $latestFile = ([regex]::Matches($page.Content, $pattern))[0].Value
        $mpvUrl = "${sfBaseUrl}${latestFile}/download"

        Invoke-WebRequest -Uri $mpvUrl -OutFile "deps\libmpv.7z" -UserAgent "Mozilla/5.0" -MaximumRedirection 10

        # Extract and verify
        7z x "deps\libmpv.7z" -odeps\libmpv -y

        $mpvDll = Get-ChildItem -Path "deps\libmpv" -Recurse -Filter "libmpv*.dll" | Select-Object -First 1
        if ($mpvDll) {
          Write-Host "libmpv-2.dll found: $($mpvDll.FullName) ($($mpvDll.Length) bytes)" -ForegroundColor Green
          "libmpv_extracted=ok" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        } else {
          Write-Host "ERROR: libmpv DLL not found in archive!" -ForegroundColor Red
          Get-ChildItem -Path "deps\libmpv" -Recurse | Format-Table Name
          "libmpv_extracted=failed" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          exit 1
        }

        # Download ffprobe
        Write-Host "Downloading ffprobe..."
        Invoke-WebRequest -Uri "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip" -OutFile "deps\ffmpeg.zip"

        Expand-Archive -Path "deps\ffmpeg.zip" -DestinationPath "deps\ffmpeg" -Force

        $ffprobe = Get-ChildItem -Path "deps\ffmpeg" -Recurse -Filter "ffprobe.exe" | Select-Object -First 1
        if ($ffprobe) {
          Write-Host "ffprobe.exe found: $($ffprobe.FullName) ($($ffprobe.Length) bytes)" -ForegroundColor Green
          "ffprobe_extracted=ok" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        } else {
          Write-Host "ERROR: ffprobe.exe not found in archive!" -ForegroundColor Red
          "ffprobe_extracted=failed" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          exit 1
        }

        Write-Host "=== All downloads and extractions successful ===" -ForegroundColor Green

    - name: Summary (PowerShell)
      if: always()
      shell: pwsh
      run: |
        Write-Host "=== PowerShell Check Summary ===" -ForegroundColor Cyan
        Write-Host "libmpv URL: ${{ steps.check-libmpv-ps.outputs.status }}"
        Write-Host "libmpv file: ${{ steps.check-libmpv-ps.outputs.file }}"
        Write-Host "ffprobe URL: ${{ steps.check-ffprobe-ps.outputs.status }}"
        Write-Host "libmpv extracted: ${{ steps.test-download.outputs.libmpv_extracted }}"
        Write-Host "ffprobe extracted: ${{ steps.test-download.outputs.ffprobe_extracted }}"

  # ==========================================================================
  # CREATE ISSUE ON FAILURE
  # ==========================================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [check-bash, check-powershell]
    if: failure()

    steps:
    - name: Create GitHub Issue
      uses: actions/github-script@v7
      with:
        script: |
          const title = '⚠️ Windows Dependencies Check Failed';
          const body = `## Windows Dependencies Check Failed

          One or more Windows dependencies are unavailable or have changed.

          **Date:** ${new Date().toISOString()}
          **Workflow:** ${context.workflow}
          **Run:** ${context.runNumber}

          ### Action Required
          - Check SourceForge libmpv availability
          - Check gyan.dev ffprobe availability
          - Update fallback URLs if necessary

          [View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
          `;

          // Check if similar issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'dependencies,automated'
          });

          const existingIssue = issues.data.find(i => i.title === title);

          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['dependencies', 'automated', 'windows']
            });
            console.log('Issue created');
          } else {
            // Add comment to existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `### Check failed again\n\n**Date:** ${new Date().toISOString()}\n\n[View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });
            console.log('Comment added to existing issue');
          }
