# .github/workflows/build.yml - 3nity Media CI/CD
name: Build 3nity Media

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  APP_NAME: 3nity-media
  BINARY_NAME: 3nity-media

permissions:
  contents: write

jobs:
  # ============================================================================
  # PREFLIGHT CHECK - Verify all dependencies before building
  # ============================================================================
  preflight-check:
    name: Preflight Check
    runs-on: ubuntu-latest

    steps:
    - name: Check Linux dependencies
      run: |
        echo "=== Preflight Check: Linux Dependencies ==="
        sudo apt-get update -qq

        echo "Checking libmpv..."
        if apt-cache show libmpv2 &>/dev/null || apt-cache show libmpv1 &>/dev/null; then
          echo "✓ libmpv: available"
        else
          echo "✗ libmpv: NOT FOUND"
          exit 1
        fi

        echo "Checking libqt5pas1..."
        if apt-cache show libqt5pas1 &>/dev/null; then
          echo "✓ libqt5pas1: available"
        else
          echo "✗ libqt5pas1: NOT FOUND"
          exit 1
        fi

        echo "Checking ffmpeg..."
        if apt-cache show ffmpeg &>/dev/null; then
          echo "✓ ffmpeg: available"
        else
          echo "✗ ffmpeg: NOT FOUND"
          exit 1
        fi

        echo "Checking lazarus..."
        if apt-cache show lazarus-ide-qt5 &>/dev/null; then
          echo "✓ lazarus-ide-qt5: available"
        else
          echo "✗ lazarus-ide-qt5: NOT FOUND"
          exit 1
        fi

        echo "=== Linux dependencies: OK ==="

    - name: Check Windows dependencies
      run: |
        echo "=== Preflight Check: Windows Dependencies ==="

        # Check SourceForge libmpv
        echo "Checking libmpv on SourceForge..."
        SF_URL="https://sourceforge.net/projects/mpv-player-windows/files/libmpv/"
        PAGE=$(curl -sL "$SF_URL" --max-time 30)
        LATEST=$(echo "$PAGE" | grep -oP 'mpv-dev-x86_64-\d{8}-git-[a-f0-9]+\.7z' | head -1)

        if [ -n "$LATEST" ]; then
          echo "✓ libmpv found: $LATEST"
        else
          echo "✗ libmpv: NOT FOUND on SourceForge"
          exit 1
        fi

        # Check gyan.dev ffprobe
        echo "Checking ffprobe on gyan.dev..."
        FFMPEG_URL="https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
        HTTP_CODE=$(curl -sIL "$FFMPEG_URL" -o /dev/null -w "%{http_code}" --max-time 20)
        if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
          echo "✓ ffprobe available (HTTP $HTTP_CODE)"
        else
          echo "✗ ffprobe: NOT AVAILABLE (HTTP $HTTP_CODE)"
          exit 1
        fi

        echo "=== Windows dependencies: OK ==="

    - name: Summary
      if: success()
      run: |
        echo ""
        echo "╔════════════════════════════════════════════╗"
        echo "║  ✓ PREFLIGHT CHECK PASSED                  ║"
        echo "║    - Linux APT packages: OK                ║"
        echo "║    - Windows URLs: OK                      ║"
        echo "╚════════════════════════════════════════════╝"

  # ============================================================================
  # BUILD LINUX
  # ============================================================================
  build-linux:
    needs: preflight-check
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
        else
          VERSION="0.0.0-dev.$(date +%Y%m%d).${GITHUB_SHA::7}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"

    - name: Install Lazarus and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          lazarus-ide-qt5 \
          lazarus-src \
          lcl-qt5 \
          lcl-utils \
          fpc \
          libqt5pas1 \
          libqt5pas-dev \
          libmpv-dev \
          ffmpeg \
          build-essential

    - name: Verify installation
      run: |
        echo "=== Lazarus version ==="
        lazbuild --version
        echo "=== FPC version ==="
        fpc -iV
        echo "=== Qt5Pas ==="
        dpkg -l | grep qt5pas || true

    - name: Build Release binary
      run: |
        make clean-all
        make build-release

        echo "=== Binary info ==="
        ls -la bin/x86_64-linux/
        file bin/x86_64-linux/${{ env.BINARY_NAME }}

    - name: Test binary
      run: |
        echo "=== Testing binary execution ==="
        # Test que le binaire peut s'exécuter (affiche l'aide ou version)
        timeout 5 bin/x86_64-linux/${{ env.BINARY_NAME }} --help || true

        echo "=== Binary dependencies ==="
        ldd bin/x86_64-linux/${{ env.BINARY_NAME }} || true

    - name: Create DEB package structure
      run: |
        mkdir -p package/usr/bin
        mkdir -p package/usr/share/applications
        mkdir -p package/usr/share/icons/hicolor/16x16/apps
        mkdir -p package/usr/share/icons/hicolor/24x24/apps
        mkdir -p package/usr/share/icons/hicolor/32x32/apps
        mkdir -p package/usr/share/icons/hicolor/48x48/apps
        mkdir -p package/usr/share/icons/hicolor/64x64/apps
        mkdir -p package/usr/share/icons/hicolor/128x128/apps
        mkdir -p package/usr/share/icons/hicolor/256x256/apps
        mkdir -p package/usr/share/doc/3nity-media
        mkdir -p package/usr/share/3nity-media/locale
        mkdir -p package/DEBIAN

        # Copy binary
        cp bin/x86_64-linux/${{ env.BINARY_NAME }} package/usr/bin/
        chmod +x package/usr/bin/${{ env.BINARY_NAME }}

        # Create symlink for short alias
        ln -s ${{ env.BINARY_NAME }} package/usr/bin/3nity

        # Copy icons (all sizes)
        for size in 16 24 32 48 64 128 256; do
          if [ -f "resources/icons/${size}x${size}.png" ]; then
            cp "resources/icons/${size}x${size}.png" "package/usr/share/icons/hicolor/${size}x${size}/apps/3nity-media.png"
          fi
        done
        echo "Copied icons for sizes: 16, 24, 32, 48, 64, 128, 256"

        # Copy locale files (translations)
        if [ -d "resources/locale" ]; then
          cp resources/locale/*.lang package/usr/share/3nity-media/locale/ 2>/dev/null || true
          echo "Copied $(ls -1 package/usr/share/3nity-media/locale/*.lang 2>/dev/null | wc -l) locale files"
        fi

        # Copy documentation
        cp README.md package/usr/share/doc/3nity-media/ || true
        cp LICENSE* package/usr/share/doc/3nity-media/ || true

        # Create desktop file
        cat > package/usr/share/applications/3nity-media.desktop << 'EOF'
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=3nity Media
        GenericName=Media Player
        Comment=Modern multimedia player powered by libmpv
        Exec=3nity-media %F
        Icon=3nity-media
        Terminal=false
        Categories=AudioVideo;Audio;Video;Player;
        MimeType=audio/*;video/*;application/ogg;application/x-ogg;audio/ogg;audio/vorbis;audio/x-vorbis;audio/x-vorbis+ogg;video/ogg;video/x-ogm+ogg;video/x-theora+ogg;video/x-theora;audio/x-speex;audio/opus;audio/flac;audio/x-flac;audio/x-ms-asf;audio/x-ms-asx;audio/x-ms-wax;audio/x-pn-realaudio;audio/x-pn-realaudio-plugin;audio/x-real-audio;audio/x-realaudio;audio/mpeg;audio/mpg;audio/mp3;audio/x-mp3;audio/x-mpeg;audio/x-mpg;video/mp4;video/x-m4v;video/mpeg;video/x-mpeg;video/mpeg-system;video/x-mpeg-system;video/mp2t;video/x-msvideo;video/avi;video/divx;video/x-flv;video/quicktime;video/x-matroska;audio/x-matroska;video/webm;audio/webm;audio/wav;audio/x-wav;audio/x-pn-wav;audio/x-pn-windows-acm;video/x-ms-wmv;video/x-ms-asf;audio/x-ms-wma;
        Keywords=media;player;audio;video;music;movie;stream;radio;
        EOF

    - name: Create DEB control file
      run: |
        cat > package/DEBIAN/control << EOF
        Package: 3nity-media
        Version: ${{ steps.version.outputs.version }}
        Section: sound
        Priority: optional
        Architecture: amd64
        Depends: libc6 (>= 2.17), libqt5pas1, libmpv2 | libmpv1, ffmpeg
        Recommends: yt-dlp
        Maintainer: Nicolas DEOUX <NDXDev@gmail.com>
        Description: Modern multimedia player powered by libmpv
         3nity Media is a modern, lightweight media player built with
         Lazarus/Free Pascal and powered by the libmpv engine.
         .
         Features include:
          - Audio and video playback with libmpv
          - Playlist management (M3U, PLS, XSPF)
          - Internet radio streaming
          - Audio equalizer
          - Video adjustments
          - Keyboard shortcuts
          - Multi-language support
        Homepage: https://github.com/NDXDeveloper/3nity-media
        EOF

    - name: Build DEB package
      run: |
        dpkg-deb --build package
        DEB_FILE="3nity-media_${{ steps.version.outputs.version }}_amd64.deb"
        mv package.deb "$DEB_FILE"
        chmod a+r "$DEB_FILE"

        echo "=== DEB package info ==="
        dpkg-deb --info "$DEB_FILE"

    - name: Create portable Linux archive
      run: |
        mkdir -p 3nity-media-linux-portable
        mkdir -p 3nity-media-linux-portable/locale
        mkdir -p 3nity-media-linux-portable/icons/hicolor/16x16/apps
        mkdir -p 3nity-media-linux-portable/icons/hicolor/24x24/apps
        mkdir -p 3nity-media-linux-portable/icons/hicolor/32x32/apps
        mkdir -p 3nity-media-linux-portable/icons/hicolor/48x48/apps
        mkdir -p 3nity-media-linux-portable/icons/hicolor/64x64/apps
        mkdir -p 3nity-media-linux-portable/icons/hicolor/128x128/apps
        mkdir -p 3nity-media-linux-portable/icons/hicolor/256x256/apps

        cp bin/x86_64-linux/${{ env.BINARY_NAME }} 3nity-media-linux-portable/
        cp README.md 3nity-media-linux-portable/ || true
        cp LICENSE* 3nity-media-linux-portable/ || true

        # Create symlink for short alias
        ln -s ${{ env.BINARY_NAME }} 3nity-media-linux-portable/3nity

        # Copy icons (all sizes)
        for size in 16 24 32 48 64 128 256; do
          if [ -f "resources/icons/${size}x${size}.png" ]; then
            cp "resources/icons/${size}x${size}.png" "3nity-media-linux-portable/icons/hicolor/${size}x${size}/apps/3nity-media.png"
          fi
        done
        # Also copy 256x256 as main icon
        if [ -f "resources/icons/256x256.png" ]; then
          cp resources/icons/256x256.png 3nity-media-linux-portable/3nity-media.png
        fi
        echo "Copied icons for sizes: 16, 24, 32, 48, 64, 128, 256"

        # Copy locale files
        if [ -d "resources/locale" ]; then
          cp resources/locale/*.lang 3nity-media-linux-portable/locale/ 2>/dev/null || true
          echo "Copied $(ls -1 3nity-media-linux-portable/locale/*.lang 2>/dev/null | wc -l) locale files"
        fi

        # Create desktop file
        cat > 3nity-media-linux-portable/3nity-media.desktop << 'DESKTOP_EOF'
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=3nity Media
        GenericName=Media Player
        Comment=Modern multimedia player powered by libmpv
        Exec=3nity-media %F
        Icon=3nity-media
        Terminal=false
        Categories=AudioVideo;Audio;Video;Player;
        MimeType=audio/*;video/*;
        Keywords=media;player;audio;video;music;movie;stream;radio;
        DESKTOP_EOF

        # Create run.sh launcher
        cat > 3nity-media-linux-portable/run.sh << 'EOF'
        #!/bin/bash
        DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
        export LD_LIBRARY_PATH="$DIR/lib:$LD_LIBRARY_PATH"
        "$DIR/3nity-media" "$@"
        EOF
        chmod +x 3nity-media-linux-portable/run.sh

        # Create install-deps.sh script
        cat > 3nity-media-linux-portable/install-deps.sh << 'DEPS_EOF'
        #!/bin/bash
        #
        # 3nity Media - Dependency Installation Script
        # This script installs the required dependencies for 3nity Media
        #

        set -e

        # Colors for output
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m' # No Color

        echo -e "${BLUE}"
        echo "╔═══════════════════════════════════════════════════════════╗"
        echo "║       3nity Media - Dependency Installation Script        ║"
        echo "╚═══════════════════════════════════════════════════════════╝"
        echo -e "${NC}"

        # Check if running as root
        if [ "$EUID" -eq 0 ]; then
            SUDO=""
        else
            SUDO="sudo"
            echo -e "${YELLOW}Note: This script requires sudo privileges to install packages.${NC}"
            echo ""
        fi

        # Detect Linux distribution
        detect_distro() {
            if [ -f /etc/os-release ]; then
                . /etc/os-release
                DISTRO=$ID
                DISTRO_LIKE=$ID_LIKE
                VERSION_ID=$VERSION_ID
            elif [ -f /etc/lsb-release ]; then
                . /etc/lsb-release
                DISTRO=$DISTRIB_ID
            elif [ -f /etc/debian_version ]; then
                DISTRO="debian"
            elif [ -f /etc/fedora-release ]; then
                DISTRO="fedora"
            elif [ -f /etc/arch-release ]; then
                DISTRO="arch"
            else
                DISTRO="unknown"
            fi
            echo "$DISTRO"
        }

        DISTRO=$(detect_distro)
        echo -e "Detected distribution: ${GREEN}$DISTRO${NC}"
        echo ""

        # Install dependencies based on distribution
        case "$DISTRO" in
            ubuntu|debian|linuxmint|pop|elementary|zorin|kali)
                echo -e "${BLUE}Installing dependencies for Debian/Ubuntu-based system...${NC}"
                $SUDO apt-get update
                $SUDO apt-get install -y \
                    libmpv2 libmpv1 2>/dev/null || $SUDO apt-get install -y libmpv1 || $SUDO apt-get install -y libmpv2 \
                    libqt5pas1 \
                    ffmpeg
                ;;

            fedora)
                echo -e "${BLUE}Installing dependencies for Fedora...${NC}"
                $SUDO dnf install -y \
                    mpv-libs \
                    qt5-qtbase \
                    ffmpeg
                ;;

            centos|rhel|rocky|almalinux)
                echo -e "${BLUE}Installing dependencies for RHEL/CentOS-based system...${NC}"
                # Enable EPEL and RPM Fusion for ffmpeg
                $SUDO dnf install -y epel-release || true
                $SUDO dnf install -y --nogpgcheck \
                    https://mirrors.rpmfusion.org/free/el/rpmfusion-free-release-$(rpm -E %rhel).noarch.rpm || true
                $SUDO dnf install -y \
                    mpv-libs \
                    qt5-qtbase \
                    ffmpeg
                ;;

            opensuse*|suse|sles)
                echo -e "${BLUE}Installing dependencies for openSUSE/SUSE...${NC}"
                $SUDO zypper install -y \
                    libmpv2 \
                    libQt5Core5 libQt5Gui5 libQt5Widgets5 \
                    ffmpeg
                ;;

            arch|manjaro|endeavouros|garuda)
                echo -e "${BLUE}Installing dependencies for Arch-based system...${NC}"
                $SUDO pacman -Sy --noconfirm \
                    mpv \
                    qt5-base \
                    ffmpeg
                ;;

            gentoo)
                echo -e "${BLUE}Installing dependencies for Gentoo...${NC}"
                $SUDO emerge --ask=n \
                    media-video/mpv \
                    dev-qt/qtcore:5 \
                    media-video/ffmpeg
                ;;

            void)
                echo -e "${BLUE}Installing dependencies for Void Linux...${NC}"
                $SUDO xbps-install -Sy \
                    mpv \
                    qt5-base \
                    ffmpeg
                ;;

            alpine)
                echo -e "${BLUE}Installing dependencies for Alpine Linux...${NC}"
                $SUDO apk add \
                    mpv-libs \
                    qt5-qtbase \
                    ffmpeg
                ;;

            nixos)
                echo -e "${YELLOW}NixOS detected.${NC}"
                echo "Please add the following to your configuration.nix:"
                echo ""
                echo "  environment.systemPackages = with pkgs; ["
                echo "    mpv"
                echo "    ffmpeg"
                echo "    libsForQt5.qt5.qtbase"
                echo "  ];"
                echo ""
                echo "Then run: sudo nixos-rebuild switch"
                exit 0
                ;;

            *)
                # Try to detect based on ID_LIKE
                case "$DISTRO_LIKE" in
                    *debian*|*ubuntu*)
                        echo -e "${BLUE}Debian-like system detected, trying apt...${NC}"
                        $SUDO apt-get update
                        $SUDO apt-get install -y libmpv2 libqt5pas1 ffmpeg 2>/dev/null || \
                        $SUDO apt-get install -y libmpv1 libqt5pas1 ffmpeg
                        ;;
                    *fedora*|*rhel*)
                        echo -e "${BLUE}Fedora-like system detected, trying dnf...${NC}"
                        $SUDO dnf install -y mpv-libs qt5-qtbase ffmpeg
                        ;;
                    *arch*)
                        echo -e "${BLUE}Arch-like system detected, trying pacman...${NC}"
                        $SUDO pacman -Sy --noconfirm mpv qt5-base ffmpeg
                        ;;
                    *)
                        echo -e "${RED}Unknown distribution: $DISTRO${NC}"
                        echo ""
                        echo "Please install the following dependencies manually:"
                        echo "  - libmpv (mpv media player library)"
                        echo "  - Qt5 base libraries"
                        echo "  - ffmpeg (for ffprobe)"
                        echo ""
                        echo "Common package names:"
                        echo "  Debian/Ubuntu: libmpv2 libqt5pas1 ffmpeg"
                        echo "  Fedora:        mpv-libs qt5-qtbase ffmpeg"
                        echo "  Arch:          mpv qt5-base ffmpeg"
                        echo "  openSUSE:      libmpv2 libQt5Core5 ffmpeg"
                        exit 1
                        ;;
                esac
                ;;
        esac

        echo ""
        echo -e "${GREEN}╔═══════════════════════════════════════════════════════════╗${NC}"
        echo -e "${GREEN}║            Dependencies installed successfully!           ║${NC}"
        echo -e "${GREEN}╚═══════════════════════════════════════════════════════════╝${NC}"
        echo ""
        echo "You can now run 3nity Media with:"
        echo "  ./run.sh"
        echo ""
        echo "Or directly:"
        echo "  ./3nity-media"
        echo ""
        DEPS_EOF
        chmod +x 3nity-media-linux-portable/install-deps.sh

        tar -czf "3nity-media-linux-portable-${{ steps.version.outputs.version }}.tar.gz" 3nity-media-linux-portable/

    # =========================================================================
    # APPIMAGE
    # =========================================================================
    - name: Create AppImage
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        # Install AppImage tools and dependencies
        sudo apt-get install -y libfuse2 file patchelf
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy*.AppImage

        # Create AppDir structure
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/lib
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/16x16/apps
        mkdir -p AppDir/usr/share/icons/hicolor/24x24/apps
        mkdir -p AppDir/usr/share/icons/hicolor/32x32/apps
        mkdir -p AppDir/usr/share/icons/hicolor/48x48/apps
        mkdir -p AppDir/usr/share/icons/hicolor/64x64/apps
        mkdir -p AppDir/usr/share/icons/hicolor/128x128/apps
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

        # Copy binary
        cp bin/x86_64-linux/${{ env.BINARY_NAME }} AppDir/usr/bin/
        chmod +x AppDir/usr/bin/${{ env.BINARY_NAME }}

        # Create symlink for short alias
        ln -s ${{ env.BINARY_NAME }} AppDir/usr/bin/3nity

        # === BUNDLE DEPENDENCIES ===
        # Copy libmpv and its dependencies
        echo "Bundling libmpv..."
        LIBMPV_PATH=$(ldconfig -p | grep libmpv.so | head -1 | awk '{print $NF}')
        if [ -n "$LIBMPV_PATH" ]; then
          cp -L "$LIBMPV_PATH" AppDir/usr/lib/
          # Also copy libmpv.so.2 or libmpv.so.1 symlinks
          for lib in /usr/lib/x86_64-linux-gnu/libmpv.so*; do
            [ -f "$lib" ] && cp -L "$lib" AppDir/usr/lib/ 2>/dev/null || true
          done
        fi

        # Copy libqt5pas
        echo "Bundling libqt5pas..."
        for lib in /usr/lib/x86_64-linux-gnu/libQt5Pas.so* /usr/lib/libQt5Pas.so*; do
          [ -f "$lib" ] && cp -L "$lib" AppDir/usr/lib/ 2>/dev/null || true
        done

        # Copy additional required libraries that may not be on all systems
        echo "Bundling additional libraries..."
        for LIB in libavformat libavcodec libavutil libswscale libswresample libass libbluray libplacebo; do
          LIBPATH=$(ldconfig -p | grep "${LIB}.so" | head -1 | awk '{print $NF}')
          if [ -n "$LIBPATH" ] && [ -f "$LIBPATH" ]; then
            cp -L "$LIBPATH" AppDir/usr/lib/ 2>/dev/null || true
          fi
        done

        # Use ldd to find and copy all dependencies of the binary
        echo "Copying binary dependencies..."
        ldd AppDir/usr/bin/${{ env.BINARY_NAME }} | grep "=> /" | awk '{print $3}' | while read lib; do
          # Skip system libraries that should be on every Linux system
          case "$lib" in
            /lib/x86_64-linux-gnu/libc.so*) continue ;;
            /lib/x86_64-linux-gnu/libm.so*) continue ;;
            /lib/x86_64-linux-gnu/libpthread*) continue ;;
            /lib/x86_64-linux-gnu/libdl*) continue ;;
            /lib/x86_64-linux-gnu/librt*) continue ;;
            /lib/x86_64-linux-gnu/ld-linux*) continue ;;
          esac
          [ -f "$lib" ] && cp -L "$lib" AppDir/usr/lib/ 2>/dev/null || true
        done

        echo "=== Libraries bundled in AppDir/usr/lib/ ==="
        ls -la AppDir/usr/lib/

        # Bundle ffprobe binary for metadata extraction
        echo "Bundling ffprobe..."
        FFPROBE_PATH=$(which ffprobe 2>/dev/null)
        if [ -n "$FFPROBE_PATH" ] && [ -f "$FFPROBE_PATH" ]; then
          cp "$FFPROBE_PATH" AppDir/usr/bin/
          chmod +x AppDir/usr/bin/ffprobe
          echo "ffprobe bundled from: $FFPROBE_PATH"
        else
          echo "Warning: ffprobe not found, metadata extraction may not work"
        fi

        # Copy icons (all sizes)
        for size in 16 24 32 48 64 128 256; do
          if [ -f "resources/icons/${size}x${size}.png" ]; then
            cp "resources/icons/${size}x${size}.png" "AppDir/usr/share/icons/hicolor/${size}x${size}/apps/3nity-media.png"
          fi
        done
        echo "Copied icons for sizes: 16, 24, 32, 48, 64, 128, 256"

        # Copy LICENSE and documentation
        mkdir -p AppDir/usr/share/doc/3nity-media
        cp LICENSE AppDir/usr/share/doc/3nity-media/ || true
        cp README.md AppDir/usr/share/doc/3nity-media/ || true

        # Copy locale files
        mkdir -p AppDir/usr/share/3nity-media/locale
        if [ -d "resources/locale" ]; then
          cp resources/locale/*.lang AppDir/usr/share/3nity-media/locale/ 2>/dev/null || true
          echo "Copied $(ls -1 AppDir/usr/share/3nity-media/locale/*.lang 2>/dev/null | wc -l) locale files"
        fi

        # Create desktop file
        cat > AppDir/usr/share/applications/3nity-media.desktop << 'EOF'
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=3nity Media
        GenericName=Media Player
        Comment=Modern multimedia player powered by libmpv
        Exec=3nity-media %F
        Icon=3nity-media
        Terminal=false
        Categories=AudioVideo;Audio;Video;Player;
        MimeType=audio/*;video/*;
        Keywords=media;player;audio;video;music;movie;
        EOF

        # Create AppRun with proper library loading
        cat > AppDir/AppRun << 'EOF'
        #!/bin/bash
        SELF=$(readlink -f "$0")
        HERE=${SELF%/*}
        export PATH="${HERE}/usr/bin:${PATH}"
        export LD_LIBRARY_PATH="${HERE}/usr/lib:${HERE}/usr/lib/x86_64-linux-gnu:${LD_LIBRARY_PATH}"
        export QT_PLUGIN_PATH="${HERE}/usr/lib/qt5/plugins:${QT_PLUGIN_PATH}"
        export QT_QPA_PLATFORM_PLUGIN_PATH="${HERE}/usr/lib/qt5/plugins/platforms:${QT_QPA_PLATFORM_PLUGIN_PATH}"
        exec "${HERE}/usr/bin/3nity-media" "$@"
        EOF
        chmod +x AppDir/AppRun

        # Symlinks required by AppImage
        ln -sf usr/share/applications/3nity-media.desktop AppDir/3nity-media.desktop
        ln -sf usr/share/icons/hicolor/256x256/apps/3nity-media.png AppDir/3nity-media.png 2>/dev/null || true

        # Build AppImage with linuxdeploy (will also bundle Qt dependencies)
        export EXTRA_QT_PLUGINS="platforms;platformthemes;iconengines"
        ARCH=x86_64 ./linuxdeploy-x86_64.AppImage \
          --appdir AppDir \
          --plugin qt \
          --output appimage \
          --desktop-file AppDir/usr/share/applications/3nity-media.desktop || \
        # Fallback: use appimagetool directly if linuxdeploy fails
        (wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage && \
         chmod +x appimagetool-x86_64.AppImage && \
         ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir)

        # Rename AppImage
        mv 3nity_Media*.AppImage "3nity-Media-${VERSION}-x86_64.AppImage" 2>/dev/null || \
        mv 3nity*.AppImage "3nity-Media-${VERSION}-x86_64.AppImage" 2>/dev/null || \
        mv *.AppImage "3nity-Media-${VERSION}-x86_64.AppImage" 2>/dev/null || true

        echo "=== AppImage created ==="
        ls -la *.AppImage 2>/dev/null || echo "AppImage creation may have failed"

    # =========================================================================
    # SNAP
    # =========================================================================
    - name: Prepare Snap package files
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        # Create snap directory structure
        mkdir -p snap/gui

        # Create desktop file for Snap
        cat > snap/gui/3nity-media.desktop << 'DESKTOP_EOF'
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=3nity Media
        GenericName=Media Player
        Comment=Modern multimedia player powered by libmpv
        Exec=3nity-media %F
        Icon=${SNAP}/meta/gui/3nity-media.png
        Terminal=false
        Categories=AudioVideo;Audio;Video;Player;
        MimeType=audio/*;video/*;
        Keywords=media;player;audio;video;music;movie;stream;radio;
        DESKTOP_EOF

        # Copy icons for Snap (all sizes)
        for size in 16 24 32 48 64 128 256; do
          if [ -f "resources/icons/${size}x${size}.png" ]; then
            cp "resources/icons/${size}x${size}.png" "snap/gui/3nity-media-${size}.png"
          fi
        done
        if [ -f "resources/icons/256x256.png" ]; then
          cp resources/icons/256x256.png snap/gui/3nity-media.png
        fi

        # Create snapcraft.yaml
        cat > snap/snapcraft.yaml << EOF
        name: 3nity-media
        version: '${VERSION}'
        summary: Modern multimedia player powered by libmpv
        description: |
          3nity Media is a modern, lightweight media player built with
          Lazarus/Free Pascal and powered by the libmpv engine.

          Features:
          - Audio and video playback with libmpv
          - Playlist management (M3U, PLS, XSPF)
          - Internet radio streaming
          - Audio equalizer
          - Video adjustments
          - Keyboard shortcuts
          - Multi-language support (100+ languages)

        grade: stable
        confinement: strict
        base: core24
        platforms:
          amd64:
            build-on: [amd64]
            build-for: [amd64]

        icon: snap/gui/3nity-media.png

        layout:
          /usr/share/libdrm:
            bind: \$SNAP/usr/share/libdrm
          /usr/lib/x86_64-linux-gnu/dri:
            bind: \$SNAP/usr/lib/x86_64-linux-gnu/dri

        apps:
          3nity-media:
            extensions: [kde-neon]
            command: usr/bin/3nity-media
            desktop: usr/share/applications/3nity-media.desktop
            environment:
              LD_LIBRARY_PATH: \$SNAP/usr/lib:\$SNAP/usr/lib/x86_64-linux-gnu:\$SNAP/usr/lib/x86_64-linux-gnu/pulseaudio:\$SNAP/usr/lib/x86_64-linux-gnu/blas:\$SNAP/usr/lib/x86_64-linux-gnu/lapack:\$LD_LIBRARY_PATH
              UBUNTU_MENUPROXY: ""
              QT_QPA_PLATFORM: xcb
              SSL_CERT_DIR: \$SNAP/etc/ssl/certs
              SSL_CERT_FILE: \$SNAP/etc/ssl/certs/ca-certificates.crt
            plugs:
              - home
              - audio-playback
              - audio-record
              - pulseaudio
              - network
              - network-bind
              - opengl
              - x11
              - wayland
              - desktop
              - desktop-legacy
              - removable-media
              - optical-drive
              - unity7
              - gsettings
              - udisks2
              - screen-inhibit-control
              - mount-observe

        parts:
          3nity-media:
            plugin: nil
            source: .
            override-build: |
              # Download and install OpenSSL 1.1.x (required by FPC for HTTPS)
              wget -q http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2_amd64.deb
              dpkg-deb -x libssl1.1_1.1.1f-1ubuntu2_amd64.deb \$SNAPCRAFT_PART_INSTALL/
              rm libssl1.1_1.1.1f-1ubuntu2_amd64.deb
              echo "=== OpenSSL 1.1 installed ==="
              ls -la \$SNAPCRAFT_PART_INSTALL/usr/lib/x86_64-linux-gnu/libssl* || true
              ls -la \$SNAPCRAFT_PART_INSTALL/usr/lib/x86_64-linux-gnu/libcrypto* || true

              # Copy binary
              mkdir -p \$SNAPCRAFT_PART_INSTALL/usr/bin
              cp bin/x86_64-linux/3nity-media \$SNAPCRAFT_PART_INSTALL/usr/bin/
              chmod +x \$SNAPCRAFT_PART_INSTALL/usr/bin/3nity-media

              # Copy locale files
              mkdir -p \$SNAPCRAFT_PART_INSTALL/usr/share/3nity-media/locale
              cp resources/locale/*.lang \$SNAPCRAFT_PART_INSTALL/usr/share/3nity-media/locale/ || true

              # Copy documentation
              mkdir -p \$SNAPCRAFT_PART_INSTALL/usr/share/doc/3nity-media
              cp LICENSE \$SNAPCRAFT_PART_INSTALL/usr/share/doc/3nity-media/ || true
              cp README.md \$SNAPCRAFT_PART_INSTALL/usr/share/doc/3nity-media/ || true

              # Copy desktop file
              mkdir -p \$SNAPCRAFT_PART_INSTALL/usr/share/applications
              cp snap/gui/3nity-media.desktop \$SNAPCRAFT_PART_INSTALL/usr/share/applications/

              # Copy icons
              for size in 16 24 32 48 64 128 256; do
                mkdir -p \$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/\${size}x\${size}/apps
                cp snap/gui/3nity-media-\${size}.png \$SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/\${size}x\${size}/apps/3nity-media.png || true
              done

              echo "=== Snap build contents ==="
              ls -la \$SNAPCRAFT_PART_INSTALL/usr/bin/
            stage-packages:
              - libmpv2
              - libqt5pas1
              - ffmpeg
              - ca-certificates
              - libva2
              - libva-drm2
              - libva-x11-2
              - libvdpau1
              - mesa-va-drivers
              - mesa-vdpau-drivers
              - libdrm2
              - libdrm-common
              - libegl1
              - libgl1
              - libglx0
              - libglvnd0
              - libpulse0
              - libpulse-mainloop-glib0
              - libasound2
              - liblua5.1-0
              - libass9
              - libbluray2
              - libcdio-paranoia2
              - libdvdnav4
              - libdvdread8
              - libjpeg8
              - librubberband2
              - libsdl2-2.0-0
              - libsixel1
              - libsmbclient
              - libuchardet0
              - libxkbcommon0
              - libxss1
              - libzimg2
              - libblas3
              - liblapack3
              - plasma-integration
              - qt5-style-plugins
              - breeze-icon-theme
              - kde-style-breeze

        EOF

        # Move README.md out of snap/ to avoid snapcraft warning
        mv snap/README.md snap/local/README.md 2>/dev/null || true

    - name: Clear snapcraft cache
      run: |
        sudo rm -rf /root/.cache/snapcraft || true
        rm -rf ~/.cache/snapcraft || true
        echo "Snapcraft cache cleared"

    - name: Build Snap package
      uses: snapcore/action-build@v1
      id: snap-build
      continue-on-error: true

    - name: Rename Snap package
      if: steps.snap-build.outcome == 'success'
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        mv *.snap "3nity-media_${VERSION}_amd64.snap" 2>/dev/null || true
        echo "=== Snap package ==="
        ls -la *.snap 2>/dev/null || echo "Snap not created"

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: linux-builds
        path: |
          3nity-media_*.deb
          3nity-media-linux-portable-*.tar.gz
          3nity-Media-*-x86_64.AppImage
          3nity-media_*_amd64.snap
          bin/x86_64-linux/${{ env.BINARY_NAME }}
        retention-days: 30

  # ============================================================================
  # BUILD WINDOWS
  # ============================================================================
  build-windows:
    runs-on: windows-latest
    needs: [preflight-check, build-linux]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Lazarus
      run: |
        Write-Host "Installing Lazarus via Chocolatey..."
        choco install lazarus -y

        # Add to PATH
        echo "C:\lazarus" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "C:\lazarus\fpc\3.2.2\bin\x86_64-win64" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Verify Lazarus installation
      run: |
        Write-Host "=== Lazarus version ==="
        & "C:\lazarus\lazbuild.exe" --version

    - name: Install make
      run: choco install make -y

    - name: Generate version file
      shell: bash
      run: |
        # Use bash shell for make compatibility
        make version-file

    - name: Build Windows binary
      run: |
        cd src

        # Build with Lazarus using native win32 widgetset (no Qt5 DLLs needed)
        # The project uses Qt5 for Linux (via LCLWidgetType macro), win32 for Windows
        & "C:\lazarus\lazbuild.exe" --build-mode=Release --widgetset=win32 TrinityMedia.lpi

        # Find and copy binary
        $binaryPath = $null
        if (Test-Path "3nity-media.exe") {
          $binaryPath = "3nity-media.exe"
        } elseif (Test-Path "..\bin\x86_64-win64\3nity-media.exe") {
          $binaryPath = "..\bin\x86_64-win64\3nity-media.exe"
        } elseif (Test-Path "..\bin\i386-win32\3nity-media.exe") {
          $binaryPath = "..\bin\i386-win32\3nity-media.exe"
        }

        if ($binaryPath) {
          Write-Host "Build successful! Binary: $binaryPath"
          Copy-Item $binaryPath "..\3nity-media.exe" -Force
          # Create alias copy for short name
          Copy-Item $binaryPath "..\3nity.exe" -Force
        } else {
          Write-Host "Searching for binary..."
          Get-ChildItem -Filter "*.exe" -Recurse | Format-Table Name, FullName
          exit 1
        }

        cd ..
        Get-Item "3nity-media.exe" | Format-List Name, Length
        Get-Item "3nity.exe" | Format-List Name, Length

    - name: Download Windows dependencies
      shell: bash
      run: |
        # Create deps directory
        mkdir -p deps

        echo "=== Downloading libmpv ==="
        # Download libmpv from GitHub (shinchiro/mpv-winbuild-cmake releases)
        # This is more reliable than SourceForge which has Cloudflare protection

        # Get latest release info from GitHub API (use GitHub token to avoid rate limiting)
        RELEASE_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/shinchiro/mpv-winbuild-cmake/releases/latest")

        # Check if API returned an error
        if echo "$RELEASE_INFO" | grep -q '"message"'; then
          echo "GitHub API response:"
          echo "$RELEASE_INFO"
        fi

        # Find mpv-dev-x86_64 asset (not v3 for broader compatibility)
        MPV_URL=$(echo "$RELEASE_INFO" | grep -o '"browser_download_url": "[^"]*mpv-dev-x86_64-[^v][^"]*\.7z"' | head -1 | cut -d'"' -f4)

        if [ -z "$MPV_URL" ]; then
          # Try v3 version if standard not found
          MPV_URL=$(echo "$RELEASE_INFO" | grep -o '"browser_download_url": "[^"]*mpv-dev-x86_64[^"]*\.7z"' | head -1 | cut -d'"' -f4)
        fi

        if [ -z "$MPV_URL" ]; then
          echo "ERROR: Could not find libmpv download URL from API"
          echo "Available assets:"
          echo "$RELEASE_INFO" | grep browser_download_url
          # Fallback to known working release
          echo "Using fallback URL..."
          MPV_URL="https://github.com/shinchiro/mpv-winbuild-cmake/releases/download/20260105/mpv-dev-x86_64-20260105-git-0035bb7.7z"
        fi

        echo "Downloading from: $MPV_URL"
        if ! curl -f -L -o deps/libmpv.7z "$MPV_URL"; then
          echo "WARNING: Failed to download libmpv from $MPV_URL"
          echo "Trying fallback URL..."
          FALLBACK_URL="https://github.com/shinchiro/mpv-winbuild-cmake/releases/download/20260105/mpv-dev-x86_64-20260105-git-0035bb7.7z"
          if ! curl -f -L -o deps/libmpv.7z "$FALLBACK_URL"; then
            echo "ERROR: Failed to download libmpv from fallback URL"
            exit 1
          fi
        fi

        # Extract libmpv
        7z x deps/libmpv.7z -odeps/libmpv -y

        # Find and copy the DLL
        MPV_DLL=$(find deps/libmpv -name "libmpv*.dll" | head -1)
        if [ -n "$MPV_DLL" ]; then
          cp "$MPV_DLL" .
          echo "Copied: $(basename $MPV_DLL)"
        else
          echo "ERROR: libmpv DLL not found in archive!"
          find deps/libmpv -type f
          exit 1
        fi

        echo "=== Downloading FFmpeg (ffprobe) ==="
        # Download FFmpeg essentials from gyan.dev (reliable source, includes ffprobe)
        curl -L -o deps/ffmpeg.zip "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"

        # Extract FFmpeg
        unzip -q deps/ffmpeg.zip -d deps/ffmpeg

        # Find and copy ffprobe.exe
        FFPROBE=$(find deps/ffmpeg -name "ffprobe.exe" | head -1)
        if [ -n "$FFPROBE" ]; then
          cp "$FFPROBE" ffprobe.exe
          echo "ffprobe.exe copied from: $FFPROBE"
        else
          echo "ERROR: ffprobe.exe not found in archive!"
          exit 1
        fi

        echo "=== Downloading OpenSSL 1.1.x (for HTTPS support) ==="
        # FPC 3.2.2 requires OpenSSL 1.1.x (not 3.x) - looks for libssl-1_1-x64.dll
        # Download from ICS/Overbyte (François Piette) - code signed binaries
        curl -f -L -o deps/openssl.zip "https://wiki.overbyte.eu/arch/openssl-1.1.1w-win64.zip"
        unzip -q deps/openssl.zip -d deps/openssl

        # Copy OpenSSL 1.1.x x64 DLLs
        echo "Searching for OpenSSL 1.1.x DLLs..."
        find deps/openssl -name "*.dll" -type f | head -20
        find deps/openssl -name "libssl-1_1-x64.dll" -exec cp -v {} . \;
        find deps/openssl -name "libcrypto-1_1-x64.dll" -exec cp -v {} . \;
        echo "OpenSSL DLLs in current directory:"
        ls -la libssl*.dll libcrypto*.dll 2>/dev/null || echo "Warning: OpenSSL DLLs not found"

        echo "=== Dependencies ready ==="
        # Note: Windows build uses win32 widgetset (--widgetset=win32), so no Qt5 DLLs are needed
        # The win32 widgetset uses native Windows controls
        ls -la *.dll 2>/dev/null || echo "No DLLs found"
        ls -la *.exe 2>/dev/null || echo "No EXEs found"

        # Copy locale files
        echo "=== Copying locale files ==="
        if [ -d "resources/locale" ]; then
          mkdir -p locale
          cp resources/locale/*.lang locale/ 2>/dev/null || true
          LOCALE_COUNT=$(ls locale/*.lang 2>/dev/null | wc -l)
          echo "Copied $LOCALE_COUNT locale files"
        else
          echo "No locale directory found at resources/locale"
        fi

        # Copy application icon
        echo "=== Copying application icon ==="
        if [ -f "resources/icons/3nity-media.ico" ]; then
          cp resources/icons/3nity-media.ico 3nity-media.ico
          echo "Copied 3nity-media.ico"
        else
          echo "Warning: No .ico file found at resources/icons/3nity-media.ico"
        fi

    - name: Create Windows installer script (Inno Setup)
      run: |
        $version = "${{ needs.build-linux.outputs.version }}"

        # System installer (Admin)
        $issSystemScript = @"
        #define MyAppName "3nity Media"
        #define MyAppVersion "$version"
        #define MyAppPublisher "Nicolas DEOUX"
        #define MyAppURL "https://github.com/NDXDeveloper/3nity-media"
        #define MyAppExeName "3nity-media.exe"

        [Setup]
        AppId={{3NITY-MEDIA-LAZARUS-001}
        AppName={#MyAppName}
        AppVersion={#MyAppVersion}
        AppPublisher={#MyAppPublisher}
        AppPublisherURL={#MyAppURL}
        DefaultDirName={autopf}\{#MyAppName}
        DefaultGroupName={#MyAppName}
        AllowNoIcons=yes
        OutputDir=.
        OutputBaseFilename=3nity-Media-Setup-$version
        SetupIconFile=3nity-media.ico
        Compression=lzma
        SolidCompression=yes
        WizardStyle=modern
        ArchitecturesAllowed=x64compatible
        ArchitecturesInstallIn64BitMode=x64compatible
        PrivilegesRequired=admin
        UninstallDisplayIcon={app}\3nity-media.ico

        [Languages]
        Name: "english"; MessagesFile: "compiler:Default.isl"
        Name: "french"; MessagesFile: "compiler:Languages\French.isl"

        [Tasks]
        Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

        [Files]
        Source: "3nity-media.exe"; DestDir: "{app}"; Flags: ignoreversion
        Source: "3nity.exe"; DestDir: "{app}"; Flags: ignoreversion
        Source: "3nity-media.ico"; DestDir: "{app}"; Flags: ignoreversion skipifsourcedoesntexist
        Source: "*.dll"; DestDir: "{app}"; Flags: ignoreversion skipifsourcedoesntexist
        Source: "ffprobe.exe"; DestDir: "{app}"; Flags: ignoreversion skipifsourcedoesntexist
        Source: "LICENSE"; DestDir: "{app}"; Flags: ignoreversion skipifsourcedoesntexist
        Source: "README.md"; DestDir: "{app}"; Flags: ignoreversion skipifsourcedoesntexist
        Source: "locale\*"; DestDir: "{app}\locale"; Flags: ignoreversion recursesubdirs createallsubdirs skipifsourcedoesntexist

        [Icons]
        Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; IconFilename: "{app}\3nity-media.ico"
        Name: "{group}\{cm:UninstallProgram,{#MyAppName}}"; Filename: "{uninstallexe}"
        Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; IconFilename: "{app}\3nity-media.ico"; Tasks: desktopicon

        [Run]
        Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#MyAppName}}"; Flags: nowait postinstall skipifsilent
        "@

        # User installer (No admin)
        $issUserScript = @"
        #define MyAppName "3nity Media"
        #define MyAppVersion "$version"
        #define MyAppPublisher "Nicolas DEOUX"
        #define MyAppURL "https://github.com/NDXDeveloper/3nity-media"
        #define MyAppExeName "3nity-media.exe"

        [Setup]
        AppId={{3NITY-MEDIA-LAZARUS-USER}
        AppName={#MyAppName} (User Install)
        AppVersion={#MyAppVersion}
        AppPublisher={#MyAppPublisher}
        AppPublisherURL={#MyAppURL}
        DefaultDirName={localappdata}\Programs\{#MyAppName}
        DefaultGroupName={#MyAppName}
        AllowNoIcons=yes
        OutputDir=.
        OutputBaseFilename=3nity-Media-Setup-User-$version
        SetupIconFile=3nity-media.ico
        Compression=lzma
        SolidCompression=yes
        WizardStyle=modern
        ArchitecturesAllowed=x64compatible
        ArchitecturesInstallIn64BitMode=x64compatible
        PrivilegesRequired=lowest
        UninstallDisplayIcon={app}\3nity-media.ico

        [Languages]
        Name: "english"; MessagesFile: "compiler:Default.isl"
        Name: "french"; MessagesFile: "compiler:Languages\French.isl"

        [Tasks]
        Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked

        [Files]
        Source: "3nity-media.exe"; DestDir: "{app}"; Flags: ignoreversion
        Source: "3nity.exe"; DestDir: "{app}"; Flags: ignoreversion
        Source: "3nity-media.ico"; DestDir: "{app}"; Flags: ignoreversion skipifsourcedoesntexist
        Source: "*.dll"; DestDir: "{app}"; Flags: ignoreversion skipifsourcedoesntexist
        Source: "ffprobe.exe"; DestDir: "{app}"; Flags: ignoreversion skipifsourcedoesntexist
        Source: "LICENSE"; DestDir: "{app}"; Flags: ignoreversion skipifsourcedoesntexist
        Source: "README.md"; DestDir: "{app}"; Flags: ignoreversion skipifsourcedoesntexist
        Source: "locale\*"; DestDir: "{app}\locale"; Flags: ignoreversion recursesubdirs createallsubdirs skipifsourcedoesntexist

        [Icons]
        Name: "{userprograms}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; IconFilename: "{app}\3nity-media.ico"
        Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; IconFilename: "{app}\3nity-media.ico"; Tasks: desktopicon

        [Run]
        Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#MyAppName}}"; Flags: nowait postinstall skipifsilent
        "@

        $issSystemScript | Out-File -FilePath "installer-system.iss" -Encoding utf8
        $issUserScript | Out-File -FilePath "installer-user.iss" -Encoding utf8

    - name: Install Inno Setup
      run: choco install innosetup -y

    - name: Build Windows installers
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer-system.iss
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer-user.iss

        Write-Host "=== Installers created ==="
        Get-ChildItem -Filter "*.exe" | Format-Table Name, Length

    - name: Create portable Windows archive
      run: |
        $version = "${{ needs.build-linux.outputs.version }}"

        mkdir 3nity-media-windows-portable
        Copy-Item "3nity-media.exe" "3nity-media-windows-portable\"
        Copy-Item "3nity.exe" "3nity-media-windows-portable\"
        Copy-Item "3nity-media.ico" "3nity-media-windows-portable\" -ErrorAction SilentlyContinue
        Copy-Item "*.dll" "3nity-media-windows-portable\" -ErrorAction SilentlyContinue
        Copy-Item "ffprobe.exe" "3nity-media-windows-portable\" -ErrorAction SilentlyContinue
        Copy-Item "LICENSE" "3nity-media-windows-portable\" -ErrorAction SilentlyContinue
        Copy-Item "README.md" "3nity-media-windows-portable\" -ErrorAction SilentlyContinue

        # Copy locale files
        if (Test-Path "locale") {
          New-Item -ItemType Directory -Force -Path "3nity-media-windows-portable\locale" | Out-Null
          Copy-Item "locale\*" "3nity-media-windows-portable\locale\" -ErrorAction SilentlyContinue
          $localeCount = (Get-ChildItem "3nity-media-windows-portable\locale\*.lang" -ErrorAction SilentlyContinue | Measure-Object).Count
          Write-Host "Copied $localeCount locale files to portable archive"
        }

        Write-Host "=== Portable archive contents ==="
        Get-ChildItem "3nity-media-windows-portable" | Format-Table Name, Length
        if (Test-Path "3nity-media-windows-portable\locale") {
          Write-Host "=== Locale files ==="
          Get-ChildItem "3nity-media-windows-portable\locale" | Measure-Object | Select-Object -ExpandProperty Count | ForEach-Object { Write-Host "$_ locale files" }
        }

        Compress-Archive -Path "3nity-media-windows-portable" -DestinationPath "3nity-media-windows-portable-$version.zip"

    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-builds
        path: |
          3nity-Media-Setup-*.exe
          3nity-media-windows-portable-*.zip
          3nity-media.exe
          3nity.exe
        retention-days: 30

  # ============================================================================
  # CREATE RELEASE
  # ============================================================================
  create-release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Prepare release assets
      run: |
        mkdir -p release-assets

        # Linux builds
        cp linux-builds/*.deb release-assets/ || true
        cp linux-builds/*.tar.gz release-assets/ || true
        cp linux-builds/*.AppImage release-assets/ || true
        cp linux-builds/*.snap release-assets/ || true

        # Windows builds (only installers, not raw binaries)
        cp windows-builds/3nity-Media-Setup*.exe release-assets/ || true
        cp windows-builds/*.zip release-assets/ || true

        # Documentation
        cp INSTALL release-assets/ || true

        # Create checksums
        cd release-assets
        sha256sum * > checksums.txt

        echo "=== Release assets ==="
        ls -la

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: release-assets/*
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        generate_release_notes: true
        body: |
          ## 🎵 3nity Media ${{ github.ref_name }}

          Modern cross-platform media player powered by libmpv.

          ### 📦 Downloads

          #### Linux
          | Format | File | Description |
          |--------|------|-------------|
          | **DEB** | `3nity-media_${{ needs.build-linux.outputs.version }}_amd64.deb` | Ubuntu, Debian, Linux Mint |
          | **AppImage** | `3nity-Media-${{ needs.build-linux.outputs.version }}-x86_64.AppImage` | Universal, portable |
          | **Snap** | `3nity-media_${{ needs.build-linux.outputs.version }}_amd64.snap` | Snap Store compatible |
          | **Portable** | `3nity-media-linux-portable-${{ needs.build-linux.outputs.version }}.tar.gz` | tar.gz archive |

          #### Windows
          | Format | File | Description |
          |--------|------|-------------|
          | **Installer** | `3nity-Media-Setup-${{ needs.build-linux.outputs.version }}.exe` | System install (Admin) |
          | **User Installer** | `3nity-Media-Setup-User-${{ needs.build-linux.outputs.version }}.exe` | No admin required |
          | **Portable** | `3nity-media-windows-portable-${{ needs.build-linux.outputs.version }}.zip` | ZIP archive |

          ---

          ### 🛠️ Installation

          #### Linux - DEB (Ubuntu/Debian)
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/3nity-media_${{ needs.build-linux.outputs.version }}_amd64.deb
          sudo apt install ./3nity-media_${{ needs.build-linux.outputs.version }}_amd64.deb
          ```

          #### Linux - AppImage
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/3nity-Media-${{ needs.build-linux.outputs.version }}-x86_64.AppImage
          chmod +x 3nity-Media-${{ needs.build-linux.outputs.version }}-x86_64.AppImage
          ./3nity-Media-${{ needs.build-linux.outputs.version }}-x86_64.AppImage
          ```

          #### Linux - Snap
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/3nity-media_${{ needs.build-linux.outputs.version }}_amd64.snap
          sudo snap install --dangerous 3nity-media_${{ needs.build-linux.outputs.version }}_amd64.snap
          ```

          #### Windows
          - **System installer:** Download and run `3nity-Media-Setup-${{ needs.build-linux.outputs.version }}.exe`
          - **User installer:** Download and run `3nity-Media-Setup-User-${{ needs.build-linux.outputs.version }}.exe` (no admin required)
          - **Portable:** Extract `3nity-media-windows-portable-${{ needs.build-linux.outputs.version }}.zip`

          ---

          ### ✨ Features

          - 🎬 Audio/video playback with libmpv
          - 📋 Playlist management (M3U, PLS, XSPF)
          - 📻 Internet radio / streaming
          - 🎛️ Audio equalizer
          - 🎨 Visual effects
          - ⌨️ Customizable keyboard shortcuts
          - 🌍 Multi-language support

          ### 📋 Linux Dependencies

          #### DEB (Ubuntu/Debian)
          - `libqt5pas1` - Qt5 Pascal bindings
          - `libmpv2` or `libmpv1` - Playback engine
          - `ffmpeg` - Metadata extraction (ffprobe)

          > **Note:** AppImage and Snap bundle their dependencies (including ffprobe).
          > For Fedora/openSUSE users, please use the AppImage or Snap version.

          ### 📖 Full Installation Guide
          See `INSTALL` for detailed installation instructions including how to install prerequisites (sudo, snapd) on all Linux distributions.

          ### ✅ Verification
          SHA256 checksums are available in `checksums.txt`.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
